{% include "header_buttons.html" %}
<link rel="stylesheet" href="{{ url_for('static', filename='cartography.css') }}">

<script>
  window.CARTO_SHAPE_MAP = {{ shape_activity_map | tojson | safe }};
  window.SVG_EXISTS = {{ svg_exists | tojson }};
  window.VSDX_EXISTS = {{ vsdx_exists | tojson }};
  window.CURRENT_SVG = {{ current_svg | tojson | safe }};
  window.CURRENT_VSDX = {{ current_vsdx | tojson | safe }};
  window.ACTIVE_ENTITY = {{ active_entity | tojson | safe }};
  window.ALL_ENTITIES = {{ all_entities | tojson | safe }};
</script>

<script defer src="{{ url_for('static', filename='js/activities_map.js') }}"></script>

<div class="carto-page">

  <!-- HEADER -->
  <div class="carto-header">
    <div class="carto-header-left">
      <h1>Cartographie des activit√©s</h1>
      {% if active_entity %}
        <span class="entity-badge active">üè¢ {{ active_entity.name }}</span>
      {% else %}
        <span class="entity-badge inactive">‚ö†Ô∏è Aucune entit√© active</span>
      {% endif %}
    </div>
    <button id="carto-wizard-btn" class="carto-wizard-btn">üì¶ G√©rer la cartographie</button>
  </div>

  <!-- INFO NAVIGATION -->
  <div class="carto-info-message">
    <strong>Navigation :</strong> 
    Clic gauche maintenu pour se d√©placer ‚Ä¢ Molette pour zoomer ‚Ä¢ Clic sur une activit√© pour y acc√©der
  </div>

  <!-- WIZARD UNIFI√â -->
  <div id="carto-wizard-popup" class="popup hidden" >
    <div class="wizard-overlay"></div>
    <div class="wizard-container">
      
      <div class="wizard-header">
        <h2 id="wizard-title">üì¶ Gestion de la cartographie</h2>
        <button id="close-wizard" class="btn-close">‚úï</button>
      </div>

      <div class="wizard-progress hidden" id="wizard-progress">
        <div class="progress-step" data-step="1">
          <div class="step-circle">1</div>
          <span class="step-label">Connexions</span>
        </div>
        <div class="progress-line" data-line="1"></div>
        <div class="progress-step" data-step="2">
          <div class="step-circle">2</div>
          <span class="step-label">Cartographie</span>
        </div>
        <div class="progress-line" data-line="2"></div>
        <div class="progress-step" data-step="3">
          <div class="step-circle">3</div>
          <span class="step-label">R√©capitulatif</span>
        </div>
      </div>

      <div class="wizard-content">

        <!-- √âCRAN 0 : S√âLECTION ENTIT√â -->
        <div id="wizard-screen-entities" class="wizard-screen active">
          <div class="entities-screen">
            <div class="entities-header">
              <h3>üè¢ S√©lectionnez une entit√©</h3>
              <p>Choisissez l'entit√© dont vous souhaitez g√©rer la cartographie</p>
            </div>
            <div class="new-entity-inline">
              <input type="text" id="wizard-new-entity-name" placeholder="Nom de la nouvelle entit√©..." />
              <button id="wizard-create-entity-btn" class="btn-create-entity">+ Cr√©er</button>
            </div>
            <div class="entities-grid" id="wizard-entities-list"></div>
            <div class="wizard-entities-empty hidden" id="wizard-entities-empty">
              <div class="empty-icon">üè¢</div>
              <p>Aucune entit√© cr√©√©e</p>
              <p class="hint">Cr√©ez votre premi√®re entit√© pour commencer</p>
            </div>
          </div>
        </div>

        <!-- √âCRAN 1 : CHOIX ACTION -->
        <div id="wizard-screen-action" class="wizard-screen">
          <div class="action-screen">
            <div class="selected-entity-card">
              <div class="entity-card-header">
                <div class="entity-card-icon">üè¢</div>
                <div class="entity-card-info">
                  <h3 id="selected-entity-name">Nom de l'entit√©</h3>
                  <div class="entity-card-stats">
                    <span class="stat"><strong id="selected-entity-activities">0</strong> activit√©s</span>
                    <span class="stat-separator">‚Ä¢</span>
                    <span class="stat"><strong id="selected-entity-connections">0</strong> connexions</span>
                  </div>
                </div>
                <span id="selected-entity-active-badge" class="active-badge hidden">Active</span>
              </div>
              <div class="entity-files-status">
                <div class="file-status-item">
                  <span class="file-icon">üñºÔ∏è</span>
                  <span class="file-label">SVG</span>
                  <span class="file-value" id="selected-entity-svg-value">-</span>
                </div>
                <div class="file-status-item">
                  <span class="file-icon">üìÑ</span>
                  <span class="file-label">VSDX</span>
                  <span class="file-value" id="selected-entity-vsdx-value">-</span>
                </div>
              </div>
            </div>

            <div class="action-section-title"><h4>Actions cartographie</h4></div>
            <div class="wizard-actions-grid">
              <button id="wizard-new-btn" class="wizard-action-card">
                <div class="action-card-icon">‚ú®</div>
                <div class="action-card-content">
                  <strong>Nouvelle cartographie</strong>
                  <span>Remplacer tous les fichiers</span>
                </div>
              </button>
              <button id="wizard-update-btn" class="wizard-action-card" disabled>
                <div class="action-card-icon">üîÑ</div>
                <div class="action-card-content">
                  <strong>Modifier l'existante</strong>
                  <span>Mettre √† jour les fichiers</span>
                </div>
              </button>
            </div>

            <div class="action-section-title"><h4>Actions entit√©</h4></div>
            <div class="entity-actions-row">
              <button id="wizard-activate-btn" class="btn-action activate">‚úî Activer</button>
              <button id="wizard-rename-btn" class="btn-action rename">‚úèÔ∏è Renommer</button>
              <button id="wizard-delete-btn" class="btn-action delete">üóëÔ∏è Supprimer</button>
            </div>

            <div class="wizard-nav">
              <button id="action-back" class="wizard-btn-secondary">‚Üê Retour aux entit√©s</button>
            </div>
          </div>
        </div>

        <!-- √âTAPE 1 : VSDX -->
        <div id="wizard-screen-step1" class="wizard-screen">
          <div class="wizard-step-header">
            <div class="step-icon vsdx">üìÑ</div>
            <div class="step-info">
              <h3>√âtape 1 : Fichier de connexions</h3>
              <p>Importez votre fichier Visio (.vsdx) contenant les connexions</p>
            </div>
          </div>
          <div id="keep-vsdx-option" class="keep-current-option hidden">
            <label class="keep-checkbox">
              <input type="checkbox" id="keep-vsdx-checkbox">
              <span class="checkmark"></span>
              <span class="keep-label">
                <strong>Conserver le fichier actuel</strong>
                <span class="keep-filename" id="current-vsdx-name"></span>
              </span>
            </label>
          </div>
          <div id="vsdx-dropzone-wrapper">
            <div id="vsdx-dropzone" class="wizard-dropzone">
              <div class="dropzone-content">
                <div class="dropzone-icon">üìÅ</div>
                <p class="dropzone-text">Glissez votre fichier .vsdx ici</p>
                <p class="dropzone-hint">ou cliquez pour s√©lectionner</p>
              </div>
              <input type="file" id="vsdx-file-input" accept=".vsdx" hidden>
            </div>
            <div id="vsdx-preview" class="file-preview hidden">
              <div class="preview-icon">üìÑ</div>
              <div class="preview-info">
                <span class="preview-name" id="vsdx-filename"></span>
                <span class="preview-size" id="vsdx-filesize"></span>
              </div>
              <button class="preview-remove" id="vsdx-remove">‚úï</button>
            </div>
          </div>
          <div class="step-hint">
            <span class="info-icon">üí°</span>
            <span class="info-text">Ce fichier contient les connexions entre les activit√©s (optionnel).</span>
          </div>
          <div class="wizard-nav">
            <button id="step1-back" class="wizard-btn-secondary">‚Üê Retour</button>
            <button id="step1-next" class="wizard-btn-primary">Continuer ‚Üí</button>
          </div>
        </div>

        <!-- √âTAPE 2 : SVG -->
        <div id="wizard-screen-step2" class="wizard-screen">
          <div class="wizard-step-header">
            <div class="step-icon svg">üñºÔ∏è</div>
            <div class="step-info">
              <h3>√âtape 2 : Fichier cartographie</h3>
              <p>Importez votre fichier SVG export√© depuis Visio</p>
            </div>
          </div>
          <div id="keep-svg-option" class="keep-current-option hidden">
            <label class="keep-checkbox">
              <input type="checkbox" id="keep-svg-checkbox">
              <span class="checkmark"></span>
              <span class="keep-label">
                <strong>Conserver le fichier actuel</strong>
                <span class="keep-filename" id="current-svg-name"></span>
              </span>
            </label>
          </div>
          <div id="svg-dropzone-wrapper">
            <div id="svg-dropzone" class="wizard-dropzone">
              <div class="dropzone-content">
                <div class="dropzone-icon">üìÅ</div>
                <p class="dropzone-text">Glissez votre fichier .svg ici</p>
                <p class="dropzone-hint">ou cliquez pour s√©lectionner</p>
              </div>
              <input type="file" id="svg-file-input" accept=".svg" hidden>
            </div>
            <div id="svg-preview" class="file-preview hidden">
              <div class="preview-icon">üñºÔ∏è</div>
              <div class="preview-info">
                <span class="preview-name" id="svg-filename"></span>
                <span class="preview-size" id="svg-filesize"></span>
              </div>
              <button class="preview-remove" id="svg-remove">‚úï</button>
            </div>
          </div>
          <div class="step-hint">
            <span class="info-icon">üí°</span>
            <span class="info-text">Exportez depuis Visio via <strong>Fichier ‚Üí Exporter ‚Üí SVG</strong>.</span>
          </div>
          <div class="wizard-nav">
            <button id="step2-back" class="wizard-btn-secondary">‚Üê Retour</button>
            <button id="step2-next" class="wizard-btn-primary">Continuer ‚Üí</button>
          </div>
        </div>

        <!-- √âTAPE 3 : R√âCAPITULATIF -->
        <div id="wizard-screen-step3" class="wizard-screen">
          <div class="wizard-step-header">
            <div class="step-icon recap">üìã</div>
            <div class="step-info">
              <h3>√âtape 3 : R√©capitulatif</h3>
              <p>V√©rifiez les informations avant de valider</p>
            </div>
          </div>
          <div class="recap-entity">
            <span class="recap-entity-label">Entit√© :</span>
            <span class="recap-entity-name" id="recap-entity-name">-</span>
          </div>
          <div class="recap-files">
            <div class="recap-file-card" id="recap-vsdx">
              <div class="recap-file-icon vsdx">üìÑ</div>
              <div class="recap-file-info">
                <span class="recap-file-type">Fichier VSDX</span>
                <span class="recap-file-name" id="recap-vsdx-name">-</span>
              </div>
              <div class="recap-file-status" id="recap-vsdx-status"></div>
            </div>
            <div class="recap-file-card" id="recap-svg">
              <div class="recap-file-icon svg">üñºÔ∏è</div>
              <div class="recap-file-info">
                <span class="recap-file-type">Fichier SVG</span>
                <span class="recap-file-name" id="recap-svg-name">-</span>
              </div>
              <div class="recap-file-status" id="recap-svg-status"></div>
            </div>
          </div>
          <div id="connections-preview-section" class="connections-preview-section hidden">
            <h4>Aper√ßu des connexions</h4>
            
            <!-- Message info pour mode cr√©ation -->
            <div id="new-mode-info" class="new-mode-info hidden">
              <span class="info-icon">‚ÑπÔ∏è</span>
              <p>Les activit√©s seront automatiquement cr√©√©es √† partir du fichier SVG lors de l'import.</p>
            </div>
            
            <div class="connections-stats" id="wizard-connections-stats"></div>
            <div id="wizard-missing-warning" class="warning-box hidden">
              <strong>‚ö†Ô∏è Activit√©s non trouv√©es :</strong>
              <ul id="wizard-missing-list"></ul>
            </div>
            <div class="connections-table-wrapper">
              <table class="connections-table" id="wizard-connections-table">
                <thead><tr><th>Source</th><th>‚Üí</th><th>Cible</th><th>Donn√©e</th><th>Type</th><th>Statut</th></tr></thead>
                <tbody id="wizard-connections-tbody"></tbody>
              </table>
            </div>
            <div class="import-option">
              <label class="import-checkbox">
                <input type="checkbox" id="clear-connections-checkbox">
                <span class="checkmark"></span>
                <span>Supprimer les connexions existantes avant import</span>
              </label>
            </div>
          </div>
          <div id="no-vsdx-message" class="no-vsdx-message hidden">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <p>Aucun fichier VSDX ‚Äî les connexions existantes seront conserv√©es.</p>
          </div>
          <div class="wizard-nav">
            <button id="step3-back" class="wizard-btn-secondary">‚Üê Retour</button>
            <button id="step3-submit" class="wizard-btn-success">‚úì Valider et importer</button>
          </div>
        </div>

        <!-- √âCRAN TRAITEMENT -->
        <div id="wizard-screen-processing" class="wizard-screen">
          <div class="processing-content">
            <div class="processing-spinner"></div>
            <h3>Traitement en cours...</h3>
            <p>Veuillez patienter</p>
            <div class="processing-steps">
              <div class="processing-step" id="proc-step-svg"><span class="proc-icon">‚è≥</span> Importation cartographie</div>
              <div class="processing-step" id="proc-step-vsdx"><span class="proc-icon">‚è≥</span> Analyse connexions</div>
              <div class="processing-step" id="proc-step-save"><span class="proc-icon">‚è≥</span> Enregistrement</div>
            </div>
          </div>
        </div>

        <!-- √âCRAN SUCC√àS -->
        <div id="wizard-screen-success" class="wizard-screen">
          <div class="success-content">
            <div class="success-icon">‚úì</div>
            <h3>Importation r√©ussie !</h3>
            <p id="success-message">Cartographie mise √† jour avec succ√®s.</p>
            <div class="success-stats" id="success-stats"></div>
            <button id="success-close" class="wizard-btn-primary">Fermer et actualiser</button>
          </div>
        </div>

        <!-- √âCRAN ERREUR -->
        <div id="wizard-screen-error" class="wizard-screen">
          <div class="error-content">
            <div class="error-icon">‚úï</div>
            <h3>Une erreur s'est produite</h3>
            <p id="error-message">Impossible de terminer l'importation.</p>
            <div class="error-actions">
              <button id="error-retry" class="wizard-btn-secondary">R√©essayer</button>
              <button id="error-close" class="wizard-btn-primary">Fermer</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MODAL SUPPRESSION - Style inline de s√©curit√© -->
  <div id="confirm-delete-modal" class="modal hidden" >
    <div class="modal-content modal-danger">
      <h3>‚ö†Ô∏è Confirmer la suppression</h3>
      <p>Cette action supprimera d√©finitivement l'entit√© et toutes ses donn√©es.</p>
      <p class="delete-warning-final">Cette action est <strong>IRR√âVERSIBLE</strong>.</p>
      <div class="modal-actions">
        <button id="cancel-delete-btn" class="btn-gray">Annuler</button>
        <button id="confirm-delete-btn" class="btn-red">üóëÔ∏è Supprimer</button>
      </div>
    </div>
  </div>

  <!-- MODAL RENOMMAGE - Style inline de s√©curit√© -->
  <div id="rename-modal" class="modal hidden" >
    <div class="modal-content">
      <h3>‚úèÔ∏è Renommer l'entit√©</h3>
      <input type="text" id="rename-input" placeholder="Nouveau nom" />
      <div class="modal-actions">
        <button id="cancel-rename-btn" class="btn-gray">Annuler</button>
        <button id="confirm-rename-btn" class="btn-blue">Renommer</button>
      </div>
    </div>
  </div>

  <!-- CONTENU PRINCIPAL -->
  <div class="carto-container">
    <div class="carto-left">
      <div class="carto-toolbar">
        <button id="carto-zoom-out">‚àí</button>
        <button id="carto-zoom-reset">100%</button>
        <button id="carto-zoom-in">+</button>
      </div>
      <div id="carto-pan-wrapper" class="carto-pan-wrapper">
        <div id="pan-inner">
          <div id="svg-container"></div>
        </div>
      </div>
    </div>
    <div class="carto-right">
      <h2>Liste des activit√©s</h2>
      {% if activities %}
        <ul class="activities-list">
          {% for a in activities %}
            <li class="activity-item" data-id="{{ a.id }}">
              <span class="num">{{ loop.index }}</span>
              <span class="label">{{ a.name }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="no-activities">
          <p>Aucune activit√© pour cette entit√©.</p>
          <p class="hint">Utilisez le bouton "üì¶ G√©rer la cartographie" pour importer.</p>
        </div>
      {% endif %}
    </div>
  </div>

</div>