{% include "header_buttons.html" %}
<link rel="stylesheet" href="{{ url_for('static', filename='cartography.css') }}">

<script>
  window.CARTO_SHAPE_MAP = {{ shape_activity_map | tojson | safe }};
  window.SVG_EXISTS = {{ svg_exists | tojson | safe }};
  window.ACTIVE_ENTITY = {{ active_entity_dict | tojson | safe }};
  window.ALL_ENTITIES = {{ all_entities_list | tojson | safe }};
</script>

<script defer src="{{ url_for('static', filename='js/activities_map.js') }}"></script>

<div class="carto-page">

  <div class="carto-header">
    <div class="carto-header-left">
      <h1>Cartographie des activit√©s</h1>
      {% if active_entity %}
        <span class="active-entity-badge">
          <span class="badge-icon">üè¢</span>
          <span class="badge-name">{{ active_entity.name }}</span>
        </span>
      {% else %}
        <span class="no-entity-badge">
          <span class="badge-icon">‚ö†Ô∏è</span>
          <span class="badge-name">Aucune entit√© s√©lectionn√©e</span>
        </span>
      {% endif %}
    </div>

    <button id="entity-manager-btn" class="carto-actions-btn">
        üè¢ Gestionnaire d'entit√©s
    </button>
  </div>

  <!-- MESSAGE D'INFO NAVIGATION -->
  {% if active_entity and svg_exists %}
  <div class="carto-info-message">
    <span>
      <strong>Navigation :</strong> 
      Clic gauche maintenu pour se d√©placer ‚Ä¢ 
      Molette pour zoomer ‚Ä¢ 
      Clic sur une activit√© pour y acc√©der
    </span>
  </div>
  {% elif not active_entity %}
  <div class="carto-info-message carto-info-warning">
    <span>
      <strong>D√©marrage :</strong> 
      Cliquez sur "Gestionnaire d'entit√©s" pour cr√©er votre premi√®re organisation et importer une cartographie.
    </span>
  </div>
  {% elif not svg_exists %}
  <div class="carto-info-message carto-info-warning">
    <span>
      <strong>Cartographie manquante :</strong> 
      L'entit√© "{{ active_entity.name }}" n'a pas encore de cartographie. Importez un fichier SVG ou VSDX.
    </span>
  </div>
  {% endif %}

  <!-- POPUP GESTIONNAIRE D'ENTIT√âS -->
  <div id="entity-manager-popup" class="popup hidden">
    <div class="popup-content entity-manager-content">

      <div class="popup-header">
        <h2>üè¢ Gestionnaire d'entit√©s</h2>
        <button id="close-popup" class="popup-close-btn">‚úï</button>
      </div>

      <p class="popup-subtitle">
        Une entit√© repr√©sente une organisation avec sa cartographie et ses donn√©es associ√©es.
      </p>

      <!-- SECTION: Cr√©er une nouvelle entit√© -->
      <div class="entity-section">
        <h3>‚ûï Cr√©er une nouvelle entit√©</h3>
        <div class="create-entity-form">
          <input type="text" id="new-entity-name" placeholder="Nom de l'organisation..." class="entity-input">
          <input type="text" id="new-entity-description" placeholder="Description (optionnel)" class="entity-input">
          <button id="create-entity-btn" class="btn-green">
            Cr√©er l'entit√©
          </button>
        </div>
        <div id="create-entity-status" class="status-message"></div>
      </div>

      <hr>

      <!-- SECTION: Liste des entit√©s -->
      <div class="entity-section">
        <h3>üìã Entit√©s existantes</h3>
        
        <div id="entities-list" class="entities-list">
          <!-- Charg√© dynamiquement -->
          <div class="entities-loading">Chargement...</div>
        </div>
      </div>

      <!-- SECTION: D√©tails de l'entit√© s√©lectionn√©e -->
      <div id="entity-details" class="entity-details hidden">
        <hr>
        <h3>‚öôÔ∏è Gestion de l'entit√© : <span id="selected-entity-name"></span></h3>
        
        <div class="entity-actions-grid">
          <!-- Upload cartographie -->
          <div class="entity-action-card">
            <h4>üìÑ Cartographie</h4>
            <div id="dropzone" class="dropzone">
              <div class="dropzone-icon">üìÅ</div>
              <div class="dropzone-text">D√©posez un fichier <strong>.SVG</strong> ou <strong>.VSDX</strong></div>
              <div class="dropzone-hint">(SVG recommand√©)</div>
            </div>
            <div id="dropzone-status"></div>
            <button id="sync-carto-btn" class="btn-blue btn-small">
              üîÑ Synchroniser les activit√©s
            </button>
          </div>

          <!-- Actions entit√© -->
          <div class="entity-action-card">
            <h4>üîß Actions</h4>
            <div class="entity-buttons">
              <button id="rename-entity-btn" class="btn-outline">
                ‚úèÔ∏è Renommer
              </button>
              <button id="activate-entity-btn" class="btn-green">
                ‚úÖ Activer cette entit√©
              </button>
              <button id="delete-entity-btn" class="btn-red-outline">
                üóëÔ∏è Supprimer
              </button>
            </div>
          </div>
        </div>

        <!-- Stats entit√© -->
        <div class="entity-stats">
          <div class="stat-item">
            <span class="stat-value" id="stat-activities">0</span>
            <span class="stat-label">Activit√©s</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-svg">‚Äî</span>
            <span class="stat-label">Cartographie</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-updated">‚Äî</span>
            <span class="stat-label">Derni√®re MAJ</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- CONTENU PRINCIPAL -->
  <div class="carto-container">

    <!-- SVG -->
    <div class="carto-left">

      <div class="carto-toolbar">
        <button id="carto-zoom-out">‚àí</button>
        <button id="carto-zoom-reset">50%</button>
        <button id="carto-zoom-in">+</button>
      </div>

      <!-- Zone pan/zoom avec SVG inline -->
      <div id="carto-pan-wrapper" class="carto-pan-wrapper">
        <div id="pan-inner">
          <div id="svg-container" class="svg-container">
            {% if not active_entity %}
              <div class="svg-placeholder">
                <div class="placeholder-icon">üè¢</div>
                <h3>Bienvenue !</h3>
                <p>Cr√©ez ou s√©lectionnez une entit√© pour commencer.</p>
                <button onclick="document.getElementById('entity-manager-popup').classList.remove('hidden')" class="btn-green">
                  Ouvrir le gestionnaire d'entit√©s
                </button>
              </div>
            {% elif not svg_exists %}
              <div class="svg-placeholder">
                <div class="placeholder-icon">üìÑ</div>
                <h3>Cartographie manquante</h3>
                <p>Importez un fichier SVG ou VSDX pour l'entit√© "{{ active_entity.name }}".</p>
                <button onclick="document.getElementById('entity-manager-popup').classList.remove('hidden')" class="btn-green">
                  Importer une cartographie
                </button>
              </div>
            {% else %}
              <div class="svg-loading">Chargement de la cartographie...</div>
            {% endif %}
          </div>
        </div>
      </div>

    </div>

    <!-- LISTE ACTIVIT√âS -->
    <div class="carto-right">
      <h2>Liste des activit√©s</h2>

      {% if activities %}
        <ul class="activities-list">
          {% for a in activities %}
            <li class="activity-item" data-id="{{ a.id }}">
              <span class="num">{{ a.id }}</span>
              <span class="label">{{ a.name }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="no-activities">
          <p>Aucune activit√© pour le moment.</p>
          {% if active_entity %}
            <p class="hint">Importez une cartographie pour charger les activit√©s.</p>
          {% endif %}
        </div>
      {% endif %}
    </div>

  </div>

</div>

<!-- Modal de confirmation de suppression -->
<div id="delete-confirm-modal" class="modal hidden">
  <div class="modal-content">
    <h3>‚ö†Ô∏è Confirmer la suppression</h3>
    <p>√ätes-vous s√ªr de vouloir supprimer l'entit√© "<span id="delete-entity-name"></span>" ?</p>
    <p class="warning-text">Cette action supprimera d√©finitivement toutes les donn√©es associ√©es (activit√©s, comp√©tences, analyses de temps, etc.)</p>
    <div class="modal-buttons">
      <button id="cancel-delete-btn" class="btn-outline">Annuler</button>
      <button id="confirm-delete-btn" class="btn-red">Supprimer d√©finitivement</button>
    </div>
  </div>
</div>

<!-- Modal de renommage -->
<div id="rename-modal" class="modal hidden">
  <div class="modal-content">
    <h3>‚úèÔ∏è Renommer l'entit√©</h3>
    <input type="text" id="rename-entity-input" class="entity-input" placeholder="Nouveau nom...">
    <div class="modal-buttons">
      <button id="cancel-rename-btn" class="btn-outline">Annuler</button>
      <button id="confirm-rename-btn" class="btn-green">Renommer</button>
    </div>
  </div>
</div>