{% include "header_buttons.html" %}
<link rel="stylesheet" href="{{ url_for('static', filename='cartography.css') }}">

<script>
  // Variables globales pour le JavaScript
  window.CARTO_SHAPE_MAP = {{ shape_activity_map | tojson | safe }};
  window.SVG_EXISTS = {{ svg_exists | tojson }};
  window.VSDX_EXISTS = {{ vsdx_exists | tojson }};
  window.CURRENT_SVG = {{ current_svg | tojson | safe }};
  window.CURRENT_VSDX = {{ current_vsdx | tojson | safe }};
  window.ACTIVE_ENTITY = {{ active_entity | tojson | safe }};
  window.ALL_ENTITIES = {{ all_entities | tojson | safe }};
</script>

<script defer src="{{ url_for('static', filename='js/activities_map.js') }}"></script>

<div class="carto-page">

  <!-- HEADER -->
  <div class="carto-header">
    <div class="carto-header-left">
      <h1>Cartographie des activit√©s</h1>
      
      <!-- Badge entit√© active -->
      {% if active_entity %}
        <span class="entity-badge active">
          üè¢ {{ active_entity.name }}
        </span>
      {% else %}
        <span class="entity-badge inactive">
          ‚ö†Ô∏è Aucune entit√© active
        </span>
      {% endif %}
    </div>

    <div class="carto-header-right">
      <button id="entity-manager-btn" class="btn-entity-manager">
        üè¢ Gestionnaire d'entit√©s
      </button>
      <button id="carto-wizard-btn" class="carto-wizard-btn">
        üì¶ G√©rer la cartographie
      </button>
    </div>
  </div>

  <!-- MESSAGE D'INFO NAVIGATION -->
  <div class="carto-info-message">
    <span>
      <strong>Navigation :</strong> 
      Clic gauche (drag) pour se d√©placer ‚Ä¢ 
      Molette pour zoomer ‚Ä¢ 
      Clic gauche sur une activit√© pour y acc√©der
    </span>
  </div>

  <!-- ============================================================
       POPUP GESTIONNAIRE D'ENTIT√âS
  ============================================================ -->
  <div id="entity-manager-popup" class="popup hidden">
    <div class="popup-content popup-large">
      
      <div class="popup-header">
        <h2>üè¢ Gestionnaire d'entit√©s</h2>
        <button id="close-entity-manager" class="btn-close">‚úï</button>
      </div>

      <div class="entity-manager-layout">
        
        <!-- Colonne gauche: Liste des entit√©s -->
        <div class="entity-list-section">
          <h3>Entit√©s disponibles</h3>
          
          <!-- Formulaire nouvelle entit√© -->
          <div class="new-entity-form">
            <input type="text" id="new-entity-name" placeholder="Nom de la nouvelle entit√©" />
            <button id="create-entity-btn" class="btn-green">+ Cr√©er</button>
          </div>
          
          <!-- Liste des entit√©s -->
          <ul id="entities-list" class="entities-list">
            {% for entity in all_entities %}
              <li class="entity-item {% if entity.is_active %}active{% endif %}" 
                  data-id="{{ entity.id }}">
                <span class="entity-name">{{ entity.name }}</span>
                {% if entity.is_active %}
                  <span class="entity-active-badge">Active</span>
                {% endif %}
              </li>
            {% else %}
              <li class="no-entity">Aucune entit√© cr√©√©e</li>
            {% endfor %}
          </ul>
        </div>

        <!-- Colonne droite: D√©tails de l'entit√© s√©lectionn√©e -->
        <div class="entity-details-section">
          <div id="entity-details-placeholder" class="entity-placeholder">
            <p>üëà S√©lectionnez une entit√© pour voir ses d√©tails</p>
          </div>
          
          <div id="entity-details" class="entity-details hidden">
            <h3 id="entity-detail-name">Nom de l'entit√©</h3>
            <p id="entity-detail-description" class="entity-description"></p>
            
            <div class="entity-stats">
              <div class="stat-item">
                <span class="stat-value" id="entity-activities-count">0</span>
                <span class="stat-label">Activit√©s</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="entity-svg-status">-</span>
                <span class="stat-label">Cartographie</span>
              </div>
            </div>
            
            <!-- Actions sur l'entit√© -->
            <div class="entity-actions">
              <button id="activate-entity-btn" class="btn-blue">
                ‚úî Activer cette entit√©
              </button>
              <button id="rename-entity-btn" class="btn-gray">
                ‚úèÔ∏è Renommer
              </button>
              <button id="delete-entity-btn" class="btn-red">
                üóëÔ∏è Supprimer
              </button>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- ============================================================
       WIZARD CARTOGRAPHIE (3 √âTAPES)
  ============================================================ -->
  <div id="carto-wizard-popup" class="popup hidden">
    <div class="wizard-overlay"></div>
    <div class="wizard-container">
      
      <!-- HEADER WIZARD -->
      <div class="wizard-header">
        <h2>üì¶ Gestion de la cartographie</h2>
        <button id="close-wizard" class="btn-close">‚úï</button>
      </div>

      <!-- INDICATEUR DE PROGRESSION -->
      <div class="wizard-progress" id="wizard-progress">
        <div class="progress-step" data-step="1">
          <div class="step-circle">1</div>
          <span class="step-label">Connexions</span>
        </div>
        <div class="progress-line" data-line="1"></div>
        <div class="progress-step" data-step="2">
          <div class="step-circle">2</div>
          <span class="step-label">Cartographie</span>
        </div>
        <div class="progress-line" data-line="2"></div>
        <div class="progress-step" data-step="3">
          <div class="step-circle">3</div>
          <span class="step-label">R√©capitulatif</span>
        </div>
      </div>

      <!-- CONTENU DES √âTAPES -->
      <div class="wizard-content">

        <!-- ==================== √âCRAN D'ACCUEIL ==================== -->
        <div id="wizard-screen-home" class="wizard-screen active">
          <div class="wizard-home-content">
            <div class="wizard-home-icon">üó∫Ô∏è</div>
            <h3>Que souhaitez-vous faire ?</h3>
            <p class="wizard-home-desc">
              Importez vos fichiers Visio pour cr√©er ou mettre √† jour votre cartographie des activit√©s.
            </p>

            <div class="wizard-home-actions">
              <button id="wizard-new-btn" class="wizard-action-card">
                <div class="action-card-icon">‚ú®</div>
                <div class="action-card-content">
                  <strong>Nouvelle cartographie</strong>
                  <span>Cr√©er une cartographie √† partir de z√©ro</span>
                </div>
              </button>

              <button id="wizard-update-btn" class="wizard-action-card" {% if not svg_exists and not vsdx_exists %}disabled{% endif %}>
                <div class="action-card-icon">üîÑ</div>
                <div class="action-card-content">
                  <strong>Modifier l'existante</strong>
                  <span>Mettre √† jour les fichiers actuels</span>
                </div>
              </button>
            </div>

            <!-- Info fichiers actuels -->
            <div class="wizard-current-files">
              <h4>Fichiers actuels</h4>
              <div class="current-files-grid">
                <div class="current-file-item {% if vsdx_exists %}exists{% else %}missing{% endif %}">
                  <span class="file-icon">üìÑ</span>
                  <span class="file-type">VSDX</span>
                  <span class="file-status">
                    {% if vsdx_exists %}
                      {{ current_vsdx or "Pr√©sent" }}
                    {% else %}
                      Non import√©
                    {% endif %}
                  </span>
                </div>
                <div class="current-file-item {% if svg_exists %}exists{% else %}missing{% endif %}">
                  <span class="file-icon">üñºÔ∏è</span>
                  <span class="file-type">SVG</span>
                  <span class="file-status">
                    {% if svg_exists %}
                      {{ current_svg or "Pr√©sent" }}
                    {% else %}
                      Non import√©
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== √âTAPE 1 : VSDX ==================== -->
        <div id="wizard-screen-step1" class="wizard-screen">
          <div class="wizard-step-header">
            <div class="step-icon vsdx">üìÑ</div>
            <div class="step-info">
              <h3>√âtape 1 : Fichier de connexions</h3>
              <p>Importez votre fichier Visio (.vsdx) contenant les connexions entre activit√©s</p>
            </div>
          </div>

          <!-- Option garder l'actuel (mode update) -->
          <div id="keep-vsdx-option" class="keep-current-option hidden">
            <label class="keep-checkbox">
              <input type="checkbox" id="keep-vsdx-checkbox">
              <span class="checkmark"></span>
              <span class="keep-label">
                <strong>Conserver le fichier actuel</strong>
                <span class="keep-filename" id="current-vsdx-name"></span>
              </span>
            </label>
          </div>

          <!-- Dropzone VSDX -->
          <div id="vsdx-dropzone-wrapper">
            <div id="vsdx-dropzone" class="wizard-dropzone">
              <div class="dropzone-content">
                <div class="dropzone-icon">üìÅ</div>
                <p class="dropzone-text">Glissez votre fichier .vsdx ici</p>
                <p class="dropzone-hint">ou cliquez pour s√©lectionner</p>
              </div>
              <input type="file" id="vsdx-file-input" accept=".vsdx" hidden>
            </div>

            <!-- Aper√ßu fichier s√©lectionn√© -->
            <div id="vsdx-preview" class="file-preview hidden">
              <div class="preview-icon">üìÑ</div>
              <div class="preview-info">
                <span class="preview-name" id="vsdx-filename"></span>
                <span class="preview-size" id="vsdx-filesize"></span>
              </div>
              <button class="preview-remove" id="vsdx-remove">‚úï</button>
            </div>
          </div>

          <!-- Info -->
          <div class="wizard-step-info">
            <div class="info-icon">üí°</div>
            <div class="info-text">
              Le fichier VSDX contient les fl√®ches de connexion entre vos activit√©s.
              Ces connexions d√©finissent les flux entrants et sortants de chaque activit√©.
            </div>
          </div>

          <!-- Navigation -->
          <div class="wizard-nav">
            <button id="step1-back" class="wizard-btn-secondary">‚Üê Retour</button>
            <button id="step1-next" class="wizard-btn-primary">Continuer ‚Üí</button>
          </div>
        </div>

        <!-- ==================== √âTAPE 2 : SVG ==================== -->
        <div id="wizard-screen-step2" class="wizard-screen">
          <div class="wizard-step-header">
            <div class="step-icon svg">üñºÔ∏è</div>
            <div class="step-info">
              <h3>√âtape 2 : Cartographie visuelle</h3>
              <p>Importez votre fichier SVG export√© depuis Visio</p>
            </div>
          </div>

          <!-- Option garder l'actuel (mode update) -->
          <div id="keep-svg-option" class="keep-current-option hidden">
            <label class="keep-checkbox">
              <input type="checkbox" id="keep-svg-checkbox">
              <span class="checkmark"></span>
              <span class="keep-label">
                <strong>Conserver le fichier actuel</strong>
                <span class="keep-filename" id="current-svg-name"></span>
              </span>
            </label>
          </div>

          <!-- Dropzone SVG -->
          <div id="svg-dropzone-wrapper">
            <div id="svg-dropzone" class="wizard-dropzone">
              <div class="dropzone-content">
                <div class="dropzone-icon">üñºÔ∏è</div>
                <p class="dropzone-text">Glissez votre fichier .svg ici</p>
                <p class="dropzone-hint">ou cliquez pour s√©lectionner</p>
              </div>
              <input type="file" id="svg-file-input" accept=".svg" hidden>
            </div>

            <!-- Aper√ßu fichier s√©lectionn√© -->
            <div id="svg-preview" class="file-preview hidden">
              <div class="preview-icon">üñºÔ∏è</div>
              <div class="preview-info">
                <span class="preview-name" id="svg-filename"></span>
                <span class="preview-size" id="svg-filesize"></span>
              </div>
              <button class="preview-remove" id="svg-remove">‚úï</button>
            </div>
          </div>

          <!-- Info -->
          <div class="wizard-step-info">
            <div class="info-icon">üí°</div>
            <div class="info-text">
              Le fichier SVG est l'image de votre cartographie.
              Exportez-le depuis Visio via <strong>Fichier ‚Üí Exporter ‚Üí SVG</strong>.
            </div>
          </div>

          <!-- Navigation -->
          <div class="wizard-nav">
            <button id="step2-back" class="wizard-btn-secondary">‚Üê Retour</button>
            <button id="step2-next" class="wizard-btn-primary">Continuer ‚Üí</button>
          </div>
        </div>

        <!-- ==================== √âTAPE 3 : R√âCAPITULATIF ==================== -->
        <div id="wizard-screen-step3" class="wizard-screen">
          <div class="wizard-step-header">
            <div class="step-icon recap">üìã</div>
            <div class="step-info">
              <h3>√âtape 3 : R√©capitulatif</h3>
              <p>V√©rifiez les informations avant de valider</p>
            </div>
          </div>

          <!-- R√©cap des fichiers -->
          <div class="recap-files">
            <div class="recap-file-card" id="recap-vsdx">
              <div class="recap-file-icon vsdx">üìÑ</div>
              <div class="recap-file-info">
                <span class="recap-file-type">Fichier VSDX</span>
                <span class="recap-file-name" id="recap-vsdx-name">-</span>
              </div>
              <div class="recap-file-status" id="recap-vsdx-status"></div>
            </div>
            <div class="recap-file-card" id="recap-svg">
              <div class="recap-file-icon svg">üñºÔ∏è</div>
              <div class="recap-file-info">
                <span class="recap-file-type">Fichier SVG</span>
                <span class="recap-file-name" id="recap-svg-name">-</span>
              </div>
              <div class="recap-file-status" id="recap-svg-status"></div>
            </div>
          </div>

          <!-- Aper√ßu des connexions (si VSDX fourni) -->
          <div id="connections-preview-section" class="connections-preview-section hidden">
            <h4>Aper√ßu des connexions</h4>
            
            <div class="connections-stats" id="wizard-connections-stats">
              <!-- Stats remplies dynamiquement -->
            </div>

            <div id="wizard-missing-warning" class="warning-box hidden">
              <strong>‚ö†Ô∏è Activit√©s non trouv√©es :</strong>
              <ul id="wizard-missing-list"></ul>
            </div>

            <div class="connections-table-wrapper">
              <table class="connections-table" id="wizard-connections-table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th class="arrow-col">‚Üí</th>
                    <th>Cible</th>
                    <th>Donn√©e</th>
                    <th>Type</th>
                    <th>Statut</th>
                  </tr>
                </thead>
                <tbody id="wizard-connections-tbody">
                  <!-- Rempli dynamiquement -->
                </tbody>
              </table>
            </div>

            <!-- Option suppression connexions existantes -->
            <div class="import-option">
              <label class="import-checkbox">
                <input type="checkbox" id="clear-connections-checkbox">
                <span class="checkmark"></span>
                <span>Supprimer les connexions existantes avant import</span>
              </label>
            </div>
          </div>

          <!-- Message si pas de VSDX -->
          <div id="no-vsdx-message" class="no-vsdx-message hidden">
            <div class="info-icon">‚ÑπÔ∏è</div>
            <p>Aucun fichier VSDX fourni ‚Äî les connexions existantes seront conserv√©es.</p>
          </div>

          <!-- Navigation -->
          <div class="wizard-nav">
            <button id="step3-back" class="wizard-btn-secondary">‚Üê Retour</button>
            <button id="step3-submit" class="wizard-btn-success">‚úì Valider et importer</button>
          </div>
        </div>

        <!-- ==================== √âCRAN TRAITEMENT ==================== -->
        <div id="wizard-screen-processing" class="wizard-screen">
          <div class="processing-content">
            <div class="processing-spinner">
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
            </div>
            <h3 id="processing-title">Traitement en cours...</h3>
            <p id="processing-message">Veuillez patienter</p>
            
            <div class="processing-steps">
              <div class="processing-step" id="proc-step-svg">
                <span class="proc-icon">‚è≥</span>
                <span class="proc-label">Importation de la cartographie</span>
              </div>
              <div class="processing-step" id="proc-step-vsdx">
                <span class="proc-icon">‚è≥</span>
                <span class="proc-label">Analyse des connexions</span>
              </div>
              <div class="processing-step" id="proc-step-save">
                <span class="proc-icon">‚è≥</span>
                <span class="proc-label">Enregistrement</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== √âCRAN SUCC√àS ==================== -->
        <div id="wizard-screen-success" class="wizard-screen">
          <div class="success-content">
            <div class="success-icon">‚úì</div>
            <h3>Importation r√©ussie !</h3>
            <p id="success-message">Votre cartographie a √©t√© mise √† jour avec succ√®s.</p>
            
            <div class="success-stats" id="success-stats">
              <!-- Stats remplies dynamiquement -->
            </div>

            <button id="success-close" class="wizard-btn-primary">Fermer et actualiser</button>
          </div>
        </div>

        <!-- ==================== √âCRAN ERREUR ==================== -->
        <div id="wizard-screen-error" class="wizard-screen">
          <div class="error-content">
            <div class="error-icon">‚úï</div>
            <h3>Une erreur s'est produite</h3>
            <p id="error-message">Impossible de terminer l'importation.</p>
            
            <div class="error-actions">
              <button id="error-retry" class="wizard-btn-secondary">R√©essayer</button>
              <button id="error-close" class="wizard-btn-primary">Fermer</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ============================================================
       MODAL DE CONFIRMATION SUPPRESSION
  ============================================================ -->
  <div id="confirm-delete-modal" class="modal hidden">
    <div class="modal-content modal-danger">
      <h3>‚ö†Ô∏è Confirmer la suppression</h3>
      <p id="delete-warning-text">
        √ätes-vous s√ªr de vouloir supprimer cette entit√© ?
      </p>
      <p class="delete-warning-detail">
        <strong>ATTENTION :</strong> Cette action supprimera d√©finitivement :
      </p>
      <ul class="delete-consequences">
        <li>Toutes les activit√©s de cette entit√©</li>
        <li>Toutes les t√¢ches associ√©es</li>
        <li>Tous les r√¥les et comp√©tences</li>
        <li>Tous les savoirs, savoir-faires et aptitudes</li>
        <li>Toutes les analyses de temps</li>
        <li>La cartographie SVG</li>
      </ul>
      <p class="delete-warning-final">Cette action est <strong>IRR√âVERSIBLE</strong>.</p>
      
      <div class="modal-actions">
        <button id="cancel-delete-btn" class="btn-gray">Annuler</button>
        <button id="confirm-delete-btn" class="btn-red">üóëÔ∏è Supprimer d√©finitivement</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       MODAL DE RENOMMAGE
  ============================================================ -->
  <div id="rename-modal" class="modal hidden">
    <div class="modal-content">
      <h3>‚úèÔ∏è Renommer l'entit√©</h3>
      <input type="text" id="rename-input" placeholder="Nouveau nom" />
      <div class="modal-actions">
        <button id="cancel-rename-btn" class="btn-gray">Annuler</button>
        <button id="confirm-rename-btn" class="btn-blue">Renommer</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       CONTENU PRINCIPAL
  ============================================================ -->
  <div class="carto-container">

    <!-- SVG (charg√© inline par JavaScript) -->
    <div class="carto-left">

      <div class="carto-toolbar">
        <button id="carto-zoom-out">‚àí</button>
        <button id="carto-zoom-reset">100%</button>
        <button id="carto-zoom-in">+</button>
      </div>

      <div id="carto-pan-wrapper" class="carto-pan-wrapper">
        <div id="pan-inner">
          <!-- Le SVG sera charg√© ici par JavaScript -->
          <div id="svg-container"></div>
        </div>
      </div>

    </div>

    <!-- LISTE ACTIVIT√âS -->
    <div class="carto-right">
      <h2>Liste des activit√©s</h2>

      {% if activities %}
        <ul class="activities-list">
          {% for a in activities %}
            <li class="activity-item" data-id="{{ a.id }}">
              <span class="num">{{ loop.index }}</span>
              <span class="label">{{ a.name }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="no-activities">
          <p>Aucune activit√© pour cette entit√©.</p>
          <p class="hint">Utilisez "üì¶ G√©rer la cartographie" pour importer vos fichiers.</p>
        </div>
      {% endif %}
    </div>

  </div>

</div>