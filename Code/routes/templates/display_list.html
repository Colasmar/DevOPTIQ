<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste des activités</title>

  <!-- Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Feuille de style principale -->
  <link rel="stylesheet" href="/static/optiq.css">

  <!-- Feuille de style du spinner, à la racine de static/ -->
  <link rel="stylesheet" href="/static/spinner.css">
  
  <!-- jQuery nécessaire pour certaines fonctions -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- SortableJS pour le drag & drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
  <!-- Bouton pour mettre à jour la cartographie -->
  <button id="update-cartography-button" class="update-btn">
    <i class="fa-solid fa-arrows-rotate"></i> Mettre à jour la cartographie
  </button>

  <!-- Bouton pour accéder à la vue des rôles -->
  <a href="/roles_view/" style="display:inline-block; margin:10px 0; padding:10px 15px; background:#007BFF; color:#fff; text-decoration:none; border-radius:5px;">
    Voir la vue des rôles
  </a>

  <h1>Liste des activités</h1>

  {% for item in activity_data %}
  <div class="activity-container">
    <!-- En-tête cliquable -->
    <div class="activity-header" onclick="toggleDetails('details-{{ item.activity.id }}', this)">
      <span class="toggle-icon" id="icon-{{ item.activity.id }}">▶</span>
      <h2>{{ item.activity.name }}</h2>
    </div>

    <!-- Bloc pour afficher le rôle Garant -->
    <div style="margin:5px 0;">
      <span id="activity-garant-{{ item.activity.id }}">
        Garant : {% if item.garant %}{{ item.garant.name }}{% else %}Aucun{% endif %}
      </span>
      <button onclick="openGarantModal({{ item.activity.id }})" style="margin-left:10px;">Changer Garant</button>
    </div>

    <!-- Zone de détails (initialement masquée) -->
    <div class="activity-details" id="details-{{ item.activity.id }}" style="display:none;">
      <p>{{ item.activity.description or "" }}</p>

      <!-- Connexions entrantes / sortantes -->
      {% include "activity_connections.html" %}

      <!-- Tâches -->
      {% include "activity_tasks.html" %}

      <!-- Compétences validées + bouton "Proposer Compétences" -->
      {% include "activity_competencies.html" %}

      {% set activity_id = item.activity.id %}
      <!-- Habiletés socio-cognitives -->
      {% include "activity_softskills.html" %}
    </div>
  </div>
  {% endfor %}

  <!-- Inclusion du modal pour le rôle Garant -->
  {% include "roles_modal.html" %}

  <!-- Inclusion des modules pour compétences & softskills -->
  {% include "translate_softskills_modal.html" %}
  {% include "skills_section.html" %}
  {% include "competency_modal.html" %}

  <!-- Inclusion des scripts dans l'ordre requis -->
  <script src="/static/js/spinner.js"></script>
  <script src="/static/js/tasks.js"></script>
  <script src="/static/js/tools.js"></script>
  <script src="/static/js/competencies.js"></script>
  <script src="/static/js/softskills.js"></script>
  <script src="/static/js/translate_softskills.js"></script>
  <script src="/static/js/main.js"></script>
  <script src="/static/js/roles.js"></script>

  <!-- NOUVEAU : On ajoute tasks_roles.js pour gérer l'ajout de rôles sur les tâches -->
  <script src="/static/js/tasks_roles.js"></script>

  <script>
    document.getElementById('update-cartography-button').addEventListener('click', function() {
      fetch('/activities/update-cartography')
      .then(response => response.json())
      .then(data => {
        let msg = (data.message || "") + "\n" + (data.summary || "");
        alert(msg.trim());
        location.reload();
      })
      .catch(error => {
        alert("Erreur lors de la mise à jour de la cartographie: " + error.message);
      });
    });

    function toggleDetails(detailsId, headerElem) {
      var detailsElem = document.getElementById(detailsId);
      var iconElem = headerElem.querySelector('.toggle-icon');
      var currentDisplay = window.getComputedStyle(detailsElem).display;
      if (currentDisplay === "none") {
        detailsElem.style.display = "block";
        iconElem.textContent = "▼";
      } else {
        detailsElem.style.display = "none";
        iconElem.textContent = "▶";
      }
    }
  </script>
</body>
</html>
