<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste des activités</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- CSS principal -->
  <link rel="stylesheet" href="/static/optiq.css">
  <!-- CSS spinner -->
  <link rel="stylesheet" href="/static/spinner.css">
</head>
<body>
  <!-- Bouton cartographie -->
  <button id="update-cartography-button" class="update-btn">
    <i class="fa-solid fa-arrows-rotate"></i> Mettre à jour la cartographie
  </button>

  <!-- Bouton pour la page des rôles -->
  <button onclick="window.location.href='/roles_view'" class="update-btn">
    <i class="fa-solid fa-user"></i> Afficher les rôles
  </button>

  <h1>Liste des activités</h1>

  {% for item in activity_data %}
    <div class="activity-container">
      <div class="activity-header" onclick="toggleDetails('details-{{ item.activity.id }}', this)">
        <span class="toggle-icon" id="icon-{{ item.activity.id }}">▶</span>
        <h2>{{ item.activity.name }}</h2>
      </div>
      <div class="activity-details" id="details-{{ item.activity.id }}" style="display:none;">
        <p>{{ item.activity.description or "" }}</p>

        <!-- Garant -->
        <div class="activity-garant" style="margin-bottom:10px;">
          <button onclick="openGarantModal({{ item.activity.id }})">Garant</button>
          <span id="activity-garant-{{ item.activity.id }}" style="margin-left:10px;">
            {% if item.garant %}
              {{ item.garant.name }}
            {% else %}
              Aucun
            {% endif %}
          </span>
        </div>

        <!-- Connexions entrantes/sortantes -->
        <div class="connections-container">
          <div class="incoming-connections">
            <h3>Connexions entrantes</h3>
            {% if item.incoming and item.incoming|length > 0 %}
              <table class="conn-table">
                <tr>
                  <th>Nom de la donnée</th>
                  <th>Provenance</th>
                </tr>
                {% for conn in item.incoming %}
                  <tr>
                    <td>
                      {% if conn.type|lower == 'déclenchante' %}
                        <span class="declenchante">{{ conn.data_name }}</span>
                      {% elif conn.type|lower == 'nourrissante' %}
                        <span class="nourrissante">{{ conn.data_name }}</span>
                      {% else %}
                        {{ conn.data_name }}
                      {% endif %}
                    </td>
                    <td>{{ conn.source_name }}</td>
                  </tr>
                {% endfor %}
              </table>
            {% else %}
              <p>Aucune connexion entrante.</p>
            {% endif %}
          </div>

          <div class="outgoing-connections">
            <h3>Connexions sortantes</h3>
            {% if item.outgoing and item.outgoing|length > 0 %}
              <table class="conn-table">
                <tr>
                  <th>Nom de la donnée</th>
                  <th>Vers</th>
                  <th>Performance</th>
                </tr>
                {% for conn in item.outgoing %}
                  <tr>
                    <td>
                      {% if conn.type|lower == 'déclenchante' %}
                        <span class="declenchante">{{ conn.data_name }}</span>
                      {% elif conn.type|lower == 'nourrissante' %}
                        <span class="nourrissante">{{ conn.data_name }}</span>
                      {% else %}
                        {{ conn.data_name }}
                      {% endif %}
                    </td>
                    <td>{{ conn.target_name }}</td>
                    <td>
                      <div id="perf-cell-{{ conn.link_id }}"
                           class="perf-container"
                           data-linkid="{{ conn.link_id }}">
                        {% if conn.performance %}
                          <!-- Performance existante -->
                          <div id="perf-display-{{ conn.performance.id }}">
                            <span id="perf-info-{{ conn.performance.id }}">
                              {{ conn.performance.name }}
                              {% if conn.performance.description %}
                                - {{ conn.performance.description }}
                              {% endif %}
                            </span>
                            <button onclick="showEditPerfForm('{{ conn.performance.id }}','{{ conn.performance.name|escapejs }}')">
                              <i class="fa-solid fa-pencil"></i>
                            </button>
                            <button onclick="deletePerformance('{{ conn.performance.id }}')">
                              <i class="fa-solid fa-trash"></i>
                            </button>
                          </div>
                          <div id="perf-edit-form-{{ conn.performance.id }}" style="display:none; margin-top:5px;">
                            <input type="text" id="perf-edit-input-{{ conn.performance.id }}" style="width:350px;" />
                            <button onclick="submitEditPerf('{{ conn.performance.id }}')">Enregistrer</button>
                            <button onclick="hideEditPerfForm('{{ conn.performance.id }}')">Annuler</button>
                          </div>
                        {% else %}
                          <!-- Aucune performance => bouton + form d'ajout -->
                          <button onclick="showAddPerfForm('{{ conn.link_id }}')">Performance</button>
                          <div id="perf-add-form-{{ conn.link_id }}" style="display:none; margin-top:5px;">
                            <input type="text" id="perf-add-input-{{ conn.link_id }}" style="width:350px;" />
                            <button onclick="submitAddPerf('{{ conn.link_id }}')">Enregistrer</button>
                            <button onclick="hideAddPerfForm('{{ conn.link_id }}')">Annuler</button>
                          </div>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </table>
            {% else %}
              <p>Aucune connexion sortante.</p>
            {% endif %}
          </div>
        </div>

        {% include "activity_constraints.html" %}
        <div id="tasks-section-{{ item.activity.id }}">
          {% set activity = item.activity %}
          {% set tasks = item.tasks %}
          {% include "tasks_partial.html" %}
        </div>

        <!-- Compétences (NF X50-124) -->
        <div style="margin-top:20px;">
          {% include "activity_competencies.html" %}
        </div>

        <!-- 4 colonnes => Savoirs, Savoir-Faire, Aptitudes, Softskills -->
        <div style="display:flex; gap:30px; margin-top:20px;">
          <div style="flex:1;">
            {% include "activity_savoirs.html" %}
          </div>
          <div style="flex:1;">
            {% include "activity_savoir_faires.html" %}
          </div>
          <div style="flex:1;">
            {% include "activity_aptitudes.html" %}
          </div>
          <div style="flex:1;">
            {% include "activity_softskills.html" %}
          </div>
        </div>

      </div>
    </div>
  {% endfor %}

  <!-- Spinner Overlay -->
  <div id="spinnerOverlay"
       style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
              background:rgba(0,0,0,0.3); z-index:9999;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
      <div class="loader"></div>
    </div>
  </div>

  <!-- Modals : compétences, roles, softskills translation -->
  {% include "competency_modal.html" %}
  {% include "roles_modal.html" %}
  {% include "translate_softskills_modal.html" %}

  <!-- 1) jQuery -->
  <script src="/static/js/jquery-3.6.0.min.js"></script>
  <!-- 2) SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- 3) Scripts du projet -->
  <script src="/static/js/spinner.js"></script>
  <script src="/static/js/tasks.js"></script>
  <script src="/static/js/tools.js"></script>
  <script src="/static/js/main.js"></script>
  <script src="/static/js/roles.js"></script>
  <script src="/static/js/tasks_roles.js"></script>
  <script src="/static/js/constraints.js"></script>
  <script src="/static/js/performance.js"></script>

  <!-- Compétences -->
  <script src="/static/js/competencies.js"></script>

  <!-- Savoirs, Savoir-Faire, Aptitudes -->
  <script src="/static/js/savoirs.js"></script>
  <script src="/static/js/savoir_faires.js"></script>
  <script src="/static/js/aptitudes.js"></script>

  <!-- Softskills (Proposer, Traduire, CRUD) -->
  <script src="/static/js/propose_softskills.js"></script>
  <script src="/static/js/softskills.js"></script>
  <script src="/static/js/translate_softskills.js"></script>

  <script>
    function toggleDetails(detailsId, headerElem) {
      const detailsElem = document.getElementById(detailsId);
      const iconElem = headerElem.querySelector('.toggle-icon');
      if (!detailsElem || !iconElem) return;

      if (detailsElem.style.display === "none" || detailsElem.style.display === "") {
        detailsElem.style.display = "block";
        iconElem.textContent = "▼";
      } else {
        detailsElem.style.display = "none";
        iconElem.textContent = "▶";
      }
    }

    const updateBtn = document.getElementById('update-cartography-button');
    if (updateBtn) {
      updateBtn.addEventListener('click', function() {
        showSpinner();
        fetch('/activities/update-cartography')
          .then(r => r.json())
          .then(resp => {
            hideSpinner();
            if (resp.error) {
              alert("Erreur : " + resp.error);
            } else {
              alert(resp.message + "\n" + (resp.summary || ""));
              window.location.reload();
            }
          })
          .catch(err => {
            hideSpinner();
            alert("Erreur : " + err.message);
          });
      });
    }
  </script>
</body>
</html>
