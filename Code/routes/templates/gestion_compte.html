{% include "header_buttons.html" %}
<link rel="stylesheet" href="./../../../static/gestion_compte.css">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<h1>Gestion des comptes utilisateurs</h1>

<div class="form-filter-container">
  <!-- Formulaire de création -->
  <div class="box half-box">
    <h2>Créer un nouvel utilisateur</h2>
    <form action="{{ url_for('gestion_compte.create_user') }}" method="POST" class="create-form">
      <label>Prénom :</label><input type="text" name="first_name" required>
      <label>Nom :</label><input type="text" name="last_name" required>
      <label>Âge :</label><input type="number" name="age">
      <label>Email :</label><input type="email" name="email" required>
      <label>Mot de passe :</label><input type="password" name="password" required>

      <label>Rôle :</label>
      <select name="role_id">
        {% for role in roles %}
          <option value="{{ role.id }}">{{ role.name }}</option>
        {% endfor %}
      </select>

      <label>Statut :</label>
      <select name="status">
        <option value="user">Utilisateur</option>
        <option value="rh">RH</option>
        <option value="administrateur">Administrateur</option>
      </select>

      <button type="submit">Créer</button>
    </form>
  </div>

  <!-- Filtres -->
  <div class="box half-box">
    <h2>Filtrer les utilisateurs</h2>
    <form id="filterForm" onsubmit="event.preventDefault(); applyFilters();">
      <input type="text" id="searchInput" placeholder="Rechercher par nom ou prénom...">
      <select id="statusFilter">
        <option value="">Tous les statuts</option>
        <option value="user">Utilisateur</option>
        <option value="rh">RH</option>
        <option value="administrateur">Administrateur</option>
      </select>
      <select id="roleFilter">
        <option value="">Tous les rôles</option>
        {% for role in roles %}
          <option value="{{ role.name }}">{{ role.name }}</option>
        {% endfor %}
      </select>
      <button type="submit">Rechercher</button>
    </form>
    <!-- Liste filtrée brute -->
    <h2>Résultats du filtre</h2>
    <div class="scrollable-list">
      <ul id="filteredList" style="margin:0; padding:0; list-style:none;">
        {% for role_name, users in role_users.items() %}
          {% for user in users %}
          <li class="user-item"
              data-name="{{ user.first_name }} {{ user.last_name }}"
              data-status="{{ user.status }}"
              data-role="{{ role_name }}"
              style="padding:8px; border-bottom:1px solid #ddd;">
            {{ user.first_name }} {{ user.last_name }} – {{ user.age or 'N/A' }} ans – Statut : {{ user.status }} – Rôle : {{ role_name }}
            <a href="{{ url_for('gestion_compte.update_user', user_id=user.id) }}" class="edit-btn">Modifier</a>
            <form method="POST" action="{{ url_for('gestion_compte.delete_user', user_id=user.id) }}" style="display:inline;">
              <button type="submit" class="delete-btn">Supprimer</button>
            </form>
          </li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>

    
</div>

<script>
function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const status = document.getElementById('statusFilter').value;
  const role = document.getElementById('roleFilter').value;

  const items = document.querySelectorAll('.user-item');
  items.forEach(li => {
    const name = li.dataset.name.toLowerCase();
    const liStatus = li.dataset.status;
    const liRole = li.dataset.role;

    const matchesSearch = name.includes(search);
    const matchesStatus = !status || liStatus === status;
    const matchesRole = !role || liRole === role;

    li.style.display = (matchesSearch && matchesStatus && matchesRole) ? 'block' : 'none';
  });
}

/*document.querySelectorAll('.toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const targetId = btn.dataset.target;
    const targetEl = document.querySelector(targetId);
    if(targetEl) {
      targetEl.style.display = (targetEl.style.display === 'none' || !targetEl.style.display) ? 'block' : 'none';
    }
  });
});*/
</script>
