<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Vue des Rôles</title>
  <!-- Votre feuille de style principale -->
  <link rel="stylesheet" href="/static/optiq.css">
  <!-- Feuille de style du spinner, à la racine de static/ -->
  <link rel="stylesheet" href="/static/spinner.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Conteneur global du rôle */
    .role-container {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #2ecc71; /* Fond vert pour le rôle */
      color: #fff;
    }
    .role-header {
      cursor: pointer;
      font-size: 1.2em;
      font-weight: bold;
      padding: 5px;
      background-color: #27ae60;
    }
    .toggle-icon {
      margin-right: 5px;
    }
    /* Blocs internes (le header conserve la couleur d'origine) */
    .role-block {
      margin: 5px 0;
      border: 1px solid rgba(255,255,255,0.6);
    }
    .block-1 { background-color: #1e8449; }
    .block-2 { background-color: #27ae60; }
    .block-3 { background-color: #27ae60; }
    .block-4 { background-color: #a9dfbf; }
    .block-header {
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      padding: 3px;
      border-bottom: 1px solid rgba(255,255,255,0.6);
      color: #fff;
    }
    /* Style commun pour le contenu déployé de tous les blocs */
    .block-content {
      display: none;
      background-color: #fff;
      color: #000;
      padding: 10px;
    }
    /* Bouton Retour */
    .back-button {
      display: inline-block;
      margin: 10px 0;
      padding: 10px 15px;
      background-color: #007BFF;
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
    }

    /* Modale d'onboarding */
    #onboardingModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 20%;
      width: 60%;
      height: 70%;
      background: #fff;
      border: 1px solid #aaa;
      padding: 20px;
      z-index: 10000;
      overflow-y: auto;
      color: #000; /* Texte noir pour lisibilité */
    }
    #onboardingModal .close-btn {
      float: right;
      cursor: pointer;
      font-size: 1.2em;
      color: #333;
    }
    .onboarding-btn {
      margin: 10px 5px;
      padding: 8px 12px;
      background-color: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Bouton pour revenir à la vue des activités -->
  <a href="/activities/view" class="back-button">
    <i class="fa-solid fa-arrow-left"></i> Retour aux activités
  </a>

  <h1>Vue des Rôles</h1>
  
  {% for item in roles_data %}
    <div class="role-container">
      <!-- En-tête du rôle, cliquable pour déplier/replier le conteneur complet -->
      <div class="role-header" onclick="toggleRoleContainer('role-body-{{ item.role.id }}', this)">
        <span class="toggle-icon" id="role-icon-{{ item.role.id }}">▶</span>
        Rôle : {{ item.role.name }}
      </div>
      <div id="role-body-{{ item.role.id }}" style="display:none;">
        <!-- Bloc 1 : Activités où ce rôle est Garant -->
        <div class="role-block block-1">
          <div class="block-header" onclick="toggleBlock('block1-{{ item.role.id }}', this)">
            <span class="toggle-icon" id="block1-icon-{{ item.role.id }}">▶</span>
            Bloc 1 : Activités où ce rôle est Garant
          </div>
          <div id="block1-{{ item.role.id }}" class="block-content">
            {% if item.block1 %}
              <ul>
                {% for act in item.block1 %}
                  <li>{{ act.name }} (ID: {{ act.id }}) - {{ act.description }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p>Aucune activité trouvée.</p>
            {% endif %}
          </div>
        </div>
        <!-- Bloc 2 : Activités/Tâches où ce rôle intervient (non Garant) -->
        <div class="role-block block-2">
          <div class="block-header" onclick="toggleBlock('block2-{{ item.role.id }}', this)">
            <span class="toggle-icon" id="block2-icon-{{ item.role.id }}">▶</span>
            Bloc 2 : Activités/Tâches où ce rôle intervient (non Garant)
          </div>
          <div id="block2-{{ item.role.id }}" class="block-content">
            {% if item.block2 %}
              <ul>
                {% for act in item.block2 %}
                  <li>{{ act.name }} (ID: {{ act.id }})</li>
                {% endfor %}
              </ul>
            {% else %}
              <p>Aucune donnée pour ce bloc.</p>
            {% endif %}
          </div>
        </div>
        <!-- Bloc 3 : Compétences associées aux activités Garant -->
        <div class="role-block block-3">
          <div class="block-header" onclick="toggleBlock('block3-{{ item.role.id }}', this)">
            <span class="toggle-icon" id="block3-icon-{{ item.role.id }}">▶</span>
            Bloc 3 : Compétences associées aux activités Garant
          </div>
          <div id="block3-{{ item.role.id }}" class="block-content">
            {% if item.block3 %}
              <ul>
                {% for comp in item.block3 %}
                  <li>{{ comp.description }} (ID: {{ comp.id }})</li>
                {% endfor %}
              </ul>
            {% else %}
              <p>Aucune compétence trouvée.</p>
            {% endif %}
          </div>
        </div>
        <!-- Bloc 4 : Habiletés socio-cognitives -->
        <div class="role-block block-4">
          <div class="block-header" onclick="toggleBlock('block4-{{ item.role.id }}', this)">
            <span class="toggle-icon" id="block4-icon-{{ item.role.id }}">▶</span>
            Bloc 4 : Habiletés socio-cognitives
          </div>
          <div id="block4-{{ item.role.id }}" class="block-content">
            {% if item.block4 %}
              <ul>
                {% for hsc in item.block4 %}
                  <li>{{ hsc.habilete }} - Niveau: {{ hsc.niveau }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p>Aucune habileté trouvée.</p>
            {% endif %}
          </div>
        </div>

        <!-- Section On-boarding : les deux boutons et la modale -->
        <div class="role-onboarding" style="margin-top:10px;">
          <button class="onboarding-btn" onclick="generateOnboarding({{ item.role.id }})">Générer On-boarding</button>
          <button class="onboarding-btn" onclick="viewOnboarding({{ item.role.id }})">Voir On-boarding</button>
        </div>
      </div>
    </div>
  {% endfor %}

  <!-- Modale d'onboarding -->
  <div id="onboardingModal">
    <span class="close-btn" onclick="closeOnboardingModal()">×</span>
    <div id="onboardingContent"></div>
  </div>

  <!-- Ajout du conteneur du spinner -->
  <div id="spinnerOverlay"
       style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
              background:rgba(0,0,0,0.3); z-index:9999;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
      <div class="loader"></div>
    </div>
  </div>

  <!-- Inclusion du script du spinner -->
  <script src="/static/js/spinner.js"></script>

  <script>
    function toggleRoleContainer(containerId, headerElem) {
      var container = document.getElementById(containerId);
      var roleId = containerId.split('-')[1];
      var icon = document.getElementById('role-icon-' + roleId);
      if (container.style.display === "none") {
        container.style.display = "block";
        icon.textContent = "▼";
      } else {
        container.style.display = "none";
        icon.textContent = "▶";
      }
    }

    function toggleBlock(blockId, headerElem) {
      var block = document.getElementById(blockId);
      var icon = document.getElementById(blockId.replace('block', 'block-icon'));
      if (!icon) {
        icon = headerElem.querySelector('.toggle-icon');
      }
      if (block.style.display === "none") {
        block.style.display = "block";
        if (icon) { icon.textContent = "▼"; }
      } else {
        block.style.display = "none";
        if (icon) { icon.textContent = "▶"; }
      }
    }

    // Version améliorée de generateOnboarding :
    // Le spinner est affiché immédiatement et reste visible pendant toute la durée de la requête.
    function generateOnboarding(roleId) {
      showSpinner();
      // Récupérer la liste des HSC à partir du bloc 4 du rôle
      var hscBlock = document.getElementById('block4-' + roleId);
      if (!hscBlock) {
        alert("Aucune HSC trouvée pour ce rôle.");
        hideSpinner();
        return;
      }
      var hscItems = hscBlock.querySelectorAll('li');
      var hscList = [];
      hscItems.forEach(function(li) {
        hscList.push(li.innerText.trim());
      });

      fetch(`/roles/${roleId}/onboarding/generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hsc_list: hscList })
      })
      .then(response => response.json())
      .then(data => {
        hideSpinner();
        if (data.error) {
          alert("Erreur : " + data.error);
        } else {
          document.getElementById('onboardingContent').innerText = data.onboarding_plan;
          document.getElementById('onboardingModal').style.display = 'block';
        }
      })
      .catch(error => {
        hideSpinner();
        alert("Erreur lors de la génération : " + error.message);
      });
    }

    function viewOnboarding(roleId) {
      showSpinner();
      fetch(`/roles/${roleId}/onboarding`, {
        method: 'GET'
      })
      .then(response => response.json())
      .then(data => {
        hideSpinner();
        if (data.error) {
          alert("Erreur : " + data.error);
        } else {
          document.getElementById('onboardingContent').innerText = data.onboarding_plan;
          document.getElementById('onboardingModal').style.display = 'block';
        }
      })
      .catch(error => {
        hideSpinner();
        alert("Erreur lors de la récupération du plan : " + error.message);
      });
    }

    function closeOnboardingModal() {
      document.getElementById('onboardingModal').style.display = 'none';
    }
  </script>
</body>
</html>
