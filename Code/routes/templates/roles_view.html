<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Vue des Rôles</title>
  <!-- Votre feuille de style principale -->
  <link rel="stylesheet" href="/static/optiq.css">
  <!-- Feuille de style du spinner, à la racine de static/ -->
  <link rel="stylesheet" href="/static/spinner.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Conteneur global du rôle */
    .role-container {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #2ecc71; /* Fond vert pour le rôle */
      color: #fff;
    }
    .role-header {
      cursor: pointer;
      font-size: 1.2em;
      font-weight: bold;
      padding: 5px;
      background-color: #27ae60;
      position: relative;
    }
    .toggle-icon {
      margin-right: 5px;
    }
    /* Icônes d'édition et de suppression pour les rôles */
    .role-edit-icon, .role-delete-icon {
      font-size: 1em;
      margin-left: 10px;
      cursor: pointer;
      color: #fff;
    }
    /* Blocs internes (le header conserve la couleur d'origine) */
    .role-block {
      margin: 5px 0;
      border: 1px solid rgba(255,255,255,0.6);
    }
    .block-1 { background-color: #1e8449; }
    .block-2 { background-color: #27ae60; }
    .block-3 { background-color: #27ae60; }
    .block-4 { background-color: #a9dfbf; }
    .block-header {
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      padding: 3px;
      border-bottom: 1px solid rgba(255,255,255,0.6);
      color: #fff;
    }
    /* Style commun pour le contenu déployé de tous les blocs */
    .block-content {
      display: none;
      background-color: #fff;
      color: #000;
      padding: 10px;
    }
    /* Bouton Retour */
    .back-button {
      display: inline-block;
      margin: 10px 0;
      padding: 10px 15px;
      background-color: #007BFF;
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
    }
    /* Modale d'onboarding */
    #onboardingModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 20%;
      width: 60%;
      height: 70%;
      background: #fff;
      border: 1px solid #aaa;
      padding: 20px;
      z-index: 10000;
      overflow-y: auto;
      color: #000; /* Texte noir pour lisibilité */
    }
    #onboardingModal .close-btn {
      float: right;
      cursor: pointer;
      font-size: 1.2em;
      color: #333;
    }
    .onboarding-btn {
      margin: 10px 5px;
      padding: 8px 12px;
      background-color: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .role-container {
    padding: 10px;
    border: 1px solid #ccc;
    margin-top: 10px;
}

.role-title {
    font-weight: bold;
    cursor: pointer;
    color: #007bff;
}

.role-details {
    display: none; /* Masqué par défaut */
    padding: 10px;
    background-color: #f8f9fa;
}

.softskill-details {
    padding: 5px;
    border: 1px dotted #6c757d;
    margin: 5px 0;
    background-color: #e9ecef;
}
  </style>
</head>
<body>
  <!-- Bouton pour revenir à la vue des activités -->
  <a href="/activities/view" class="back-button">
    <i class="fa-solid fa-arrow-left"></i> Retour aux activités
  </a>

  <h1>Vue des Rôles</h1>
  
  {% for item in roles_data %}
    <div class="role-container">
      <!-- En-tête du rôle avec icônes d'édition et de suppression -->
      <div class="role-header" onclick="toggleRoleContainer('role-body-{{ item.role.id }}', event)">
        <span class="toggle-icon" id="role-icon-{{ item.role.id }}">▶</span>
        Rôle : <span id="role-name-{{ item.role.id }}">{{ item.role.name }}</span>
        <i class="fas fa-pencil-alt role-edit-icon" onclick="editRole(event, {{ item.role.id }})"></i>
        <i class="fas fa-trash role-delete-icon" onclick="deleteRole(event, {{ item.role.id }})"></i>
      </div>
      <div id="role-body-{{ item.role.id }}" style="display:none;">
        <!-- Bloc 1 : Activités où ce rôle est Garant -->
        <div class="role-block block-1">
          <div class="block-header" onclick="toggleBlock('block1-{{ item.role.id }}', event)">
            <span class="toggle-icon" id="block1-icon-{{ item.role.id }}">▶</span>
            Bloc 1 : Activités où ce rôle est Garant
          </div>
          <div id="block1-{{ item.role.id }}" class="block-content">
            {% if item.block1 %}
              <ul>
                {% for act in item.block1 %}
                  <li>{{ act.name }} (ID: {{ act.id }}) - {{ act.description }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p>Aucune activité trouvée.</p>
            {% endif %}
          </div>
        </div>
        <!-- Bloc 2 : Activités/Tâches où ce rôle intervient (non Garant) -->
        <div class="role-block block-2">
          <div class="block-header" onclick="toggleBlock('block2-{{ item.role.id }}', event)">
            <span class="toggle-icon" id="block2-icon-{{ item.role.id }}">▶</span>
            Bloc 2 : Activités/Tâches où ce rôle intervient (non Garant)
          </div>
          <div id="block2-{{ item.role.id }}" class="block-content">
            {% if item.block2 %}
              <table style="width:100%; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th style="border: 1px solid #ccc; padding: 5px;">Activité</th>
                    <th style="border: 1px solid #ccc; padding: 5px;">Tâche</th>
                    <th style="border: 1px solid #ccc; padding: 5px;">Statut</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in item.block2 %}
                    <tr>
                      <td style="border: 1px solid #ccc; padding: 5px;">{{ t.activity_name }}</td>
                      <td style="border: 1px solid #ccc; padding: 5px;">{{ t.task_name }}</td>
                      <td style="border: 1px solid #ccc; padding: 5px;">{{ t.status }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p>Aucune donnée pour ce bloc.</p>
            {% endif %}
          </div>
        </div>
        <!-- Bloc 3 : Compétences associées aux activités Garant -->
        <div class="role-block block-3">
          <div class="block-header" onclick="toggleBlock('block3-{{ item.role.id }}', event)">
            <span class="toggle-icon" id="block3-icon-{{ item.role.id }}">▶</span>
            Bloc 3 : Compétences associées aux activités Garant
          </div>
          <div id="block3-{{ item.role.id }}" class="block-content">
            {% if item.block3 %}
              <ul>
                {% for comp in item.block3 %}
                  <li>{{ comp.description }} (ID: {{ comp.id }})</li>
                {% endfor %}
              </ul>
            {% else %}
              <p>Aucune compétence trouvée.</p>
            {% endif %}
          </div>
        </div>




        <!-- Bloc 4 : affichage sans doublons -->
        <div class="role-block block-4">
          <div class="block-header" onclick="toggleBlock('block4-{{ item.role.id }}', event)">
            <span class="toggle-icon" id="block4-icon-{{ item.role.id }}">▶</span>
            Bloc 4 : Savoirs, Savoir-faire, Aptitudes et HSC
          </div>

          <div id="block4-{{ item.role.id }}" class="block-content">
            <h3>Savoirs</h3>
            <ul>
              {% for entry in item.block4 if entry.type == 'savoir' %}
                <li>{{ entry.value }}</li>
              {% endfor %}
            </ul>

            <h3>Savoir-faire</h3>
            <ul>
              {% for entry in item.block4 if entry.type == 'savoir-faire' %}
                <li>{{ entry.value }}</li>
              {% endfor %}
            </ul>

            <h3>Aptitudes</h3>
            <ul>
              {% for entry in item.block4 if entry.type == 'aptitude' %}
                <li>{{ entry.value }}</li>
              {% endfor %}
            </ul>

            <h3>HSC (Habiletés Socio-Cognitives)</h3>
            {% set hsc_entries = item.block4 | selectattr("type", "equalto", "softskill") | list %}
            {% if hsc_entries %}
              {% for activity in hsc_entries %}
              {% include "softskills_partial.html" %}
                <!-- Assure-toi de passer l'élément de données correct ici, par exemple ss ou item -->
              {% endfor %}
            {% else %}
              <p>Aucune habileté socio-cognitive n'est enregistrée.</p>
            {% endif %}

            {% if item.block4 | length == 0 %}
              <p>Aucun savoir, savoir-faire, aptitude ou HSC trouvé.</p>
            {% endif %}
          </div>
        </div>








        <!-- Section On-boarding -->
        <div class="role-onboarding" style="margin-top:10px;">
          <button class="onboarding-btn" onclick="generateOnboarding({{ item.role.id }})">Générer On-boarding</button>
          <button class="onboarding-btn" onclick="viewOnboarding({{ item.role.id }})">Voir On-boarding</button>
        </div>
      </div>
    </div>
  {% endfor %}

  <!-- Modale d'onboarding -->
  <div id="onboardingModal">
    <span class="close-btn" onclick="closeOnboardingModal()">×</span>
    <div id="onboardingContent"></div>
  </div>

  <!-- Spinner Overlay (à inclure pour le spinner) -->
  <div id="spinnerOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.3); z-index:9999;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
      <div class="loader"></div>
    </div>
  </div>

  <!-- Inclusion du script du spinner -->
  <script src="/static/js/spinner.js"></script>
  <script>
    // Fonctions de bascule améliorées pour éviter le double-clic
    function toggleRoleContainer(containerId, event) {
      event.stopPropagation();
      var container = document.getElementById(containerId);
      var roleId = containerId.split('-')[1];
      var icon = document.getElementById('role-icon-' + roleId);
      if (container.style.display === "none" || container.style.display === "") {
        container.style.display = "block";
        icon.textContent = "▼";
      } else {
        container.style.display = "none";
        icon.textContent = "▶";
      }
    }

    function toggleBlock(blockId, event) {
      event.stopPropagation();
      var block = document.getElementById(blockId);
      var icon = document.getElementById(blockId.replace('block', 'block-icon'));
      if (!icon) {
        icon = event.currentTarget.querySelector('.toggle-icon');
      }
      if (block.style.display === "none" || block.style.display === "") {
        block.style.display = "block";
        if (icon) { icon.textContent = "▼"; }
      } else {
        block.style.display = "none";
        if (icon) { icon.textContent = "▶"; }
      }
    }

    // Génération du plan d'on-boarding
    function generateOnboarding(roleId) {
      showSpinner();
      // Utilisation d'un délai pour forcer l'affichage du spinner
      setTimeout(function() {
        var hscBlock = document.getElementById('block4-' + roleId);
        if (!hscBlock) {
          alert("Aucune HSC trouvée pour ce rôle.");
          hideSpinner();
          return;
        }
        var hscItems = hscBlock.querySelectorAll('li');
        var hscList = [];
        hscItems.forEach(function(li) {
          hscList.push(li.innerText.trim());
        });
    
        fetch(`/roles/${roleId}/onboarding/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hsc_list: hscList })
        })
        .then(response => response.json())
        .then(data => {
          hideSpinner();
          if (data.error) {
            alert("Erreur : " + data.error);
          } else {
            document.getElementById('onboardingContent').innerText = data.onboarding_plan;
            document.getElementById('onboardingModal').style.display = 'block';
          }
        })
        .catch(error => {
          hideSpinner();
          alert("Erreur lors de la génération : " + error.message);
        });
      }, 300);
    }

    function viewOnboarding(roleId) {
      showSpinner();
      setTimeout(function() {
        fetch(`/roles/${roleId}/onboarding`, {
          method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
          hideSpinner();
          if (data.error) {
            alert("Erreur : " + data.error);
          } else {
            document.getElementById('onboardingContent').innerText = data.onboarding_plan;
            document.getElementById('onboardingModal').style.display = 'block';
          }
        })
        .catch(error => {
          hideSpinner();
          alert("Erreur lors de la récupération du plan : " + error.message);
        });
      }, 300);
    }

    function closeOnboardingModal() {
      document.getElementById('onboardingModal').style.display = 'none';
    }

    // Fonction pour éditer un rôle
    function editRole(event, roleId) {
      event.stopPropagation();
      var currentName = document.getElementById('role-name-' + roleId).textContent.trim();
      var newName = prompt("Modifier le nom du rôle :", currentName);
      if (newName === null || newName.trim() === "") {
        return;
      }
      fetch(`/roles/${roleId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newName })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert("Erreur lors de la mise à jour du rôle : " + data.error);
        } else {
          document.getElementById('role-name-' + roleId).textContent = data.role.name;
          alert("Rôle mis à jour avec succès.");
        }
      })
      .catch(error => {
        alert("Erreur : " + error.message);
      });
    }

    // Fonction pour supprimer un rôle
    function deleteRole(event, roleId) {
      event.stopPropagation();
      if (!confirm("Confirmez-vous la suppression de ce rôle ?")) return;
      fetch(`/roles/${roleId}`, {
        method: "DELETE"
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert("Erreur lors de la suppression du rôle : " + data.error);
        } else {
          var roleContainer = document.getElementById('role-icon-' + roleId).closest('.role-container');
          if (roleContainer) {
            roleContainer.remove();
          }
          alert("Rôle supprimé avec succès.");
        }
      })
      .catch(error => {
        alert("Erreur : " + error.message);
      });
    }
  </script>
</body>
<script src="/static/js/roles.js"></script>
</html>
