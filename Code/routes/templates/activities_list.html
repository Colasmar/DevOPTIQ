<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste des activités</title>
  <!-- Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- SortableJS pour le drag & drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    .update-btn {
      background-color: green;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
      font-size: 1em;
    }
    .activity-container { border: 1px solid #aaa; margin-bottom: 20px; overflow: hidden; }
    .activity-header {
      background-color: #add8e6;
      padding: 5px;
      font-size: 0.9em;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .activity-header h2 { margin: 0; flex-grow: 1; }
    .toggle-icon { font-size: 1em; margin-right: 5px; }
    .activity-details { padding: 5px; display: none; }
    .connections-container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .connections-container > div { width: 48%; }
    .conn-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    .conn-table th, .conn-table td { border: 1px solid #ccc; padding: 4px; text-align: left; }
    .conn-table th { background-color: #cce5ff; }
    /* Mise en forme conditionnelle des données */
    .declenchante { font-weight: bold; }
    .nourrissante { font-style: italic; }
    .tasks-section { margin-top: 10px; }
    .task {
      border: 1px solid #ddd;
      padding: 5px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
    }
    /* Ligne principale de la tâche en deux colonnes */
    .task-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .task-left {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1;
    }
    .task-right {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
      max-width: 250px;
    }
    .task-title { max-width: 45ch; word-wrap: break-word; }
    /* Liste des outils : chaque li sur sa propre ligne */
    .tools-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .tools-list li {
      background: #f0f0f0;
      padding: 2px 5px;
      border-radius: 3px;
      margin-bottom: 5px;
      display: block;
    }
    /* Bouton d'ajout d'outil : affiché dans un li à part */
    .add-tool-li {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      display: block;
    }
    .edit-task-form {
      display: none;
      margin-top: 5px;
      border: 1px solid #ccc;
      padding: 5px;
      width: 100%;
    }
    .task-form, .tool-form {
      margin-top: 5px;
      border: 1px solid #ccc;
      padding: 5px;
    }
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 5px;
    }
    .icon-btn i { font-size: 1em; }
  </style>
</head>
<body>
  <button id="update-cartography-button" class="update-btn">
    <i class="fa-solid fa-arrows-rotate"></i> Mettre à jour la cartographie
  </button>
  <h1>Liste des activités</h1>
  <!-- Ligne de test pour vérifier que ce template est bien utilisé -->
  <p style="color:red; font-weight:bold;">Test : {{ test_hello }}</p>
  {% for item in activity_data %}
    <div class="activity-container">
      <div class="activity-header" onclick="toggleDetails('details-{{ item.activity.id }}', this)">
        <span class="toggle-icon" id="icon-{{ item.activity.id }}">▶</span>
        <h2>{{ item.activity.name }}</h2>
      </div>
      <div class="activity-details" id="details-{{ item.activity.id }}">
        <p>{{ item.activity.description or "" }}</p>
        <div class="connections-container">
          <div class="incoming-connections">
            <h3>Connexions entrantes</h3>
            {% if item.incoming and item.incoming|length > 0 %}
              <table class="conn-table">
                <tr>
                  <th>Nom de la donnée</th>
                  <th>Provenance</th>
                </tr>
                {% for conn in item.incoming %}
                  <tr>
                    <td>
                      {% if conn.type|lower == 'déclenchante' %}
                        <span class="declenchante">{{ conn.data_name }}</span>
                      {% elif conn.type|lower == 'nourrissante' %}
                        <span class="nourrissante">{{ conn.data_name }}</span>
                      {% else %}
                        {{ conn.data_name }}
                      {% endif %}
                    </td>
                    <td>{{ conn.source_name }}</td>
                  </tr>
                {% endfor %}
              </table>
            {% else %}
              <p>Aucune connexion entrante.</p>
            {% endif %}
          </div>
          <div class="outgoing-connections">
            <h3>Connexions sortantes</h3>
            {% if item.outgoing and item.outgoing|length > 0 %}
              <table class="conn-table">
                <tr>
                  <th>Nom de la donnée</th>
                  <th>Vers</th>
                </tr>
                {% for conn in item.outgoing %}
                  <tr>
                    <td>
                      {% if conn.type|lower == 'déclenchante' %}
                        <span class="declenchante">{{ conn.data_name }}</span>
                      {% elif conn.type|lower == 'nourrissante' %}
                        <span class="nourrissante">{{ conn.data_name }}</span>
                      {% else %}
                        {{ conn.data_name }}
                      {% endif %}
                    </td>
                    <td>{{ conn.target_name }}</td>
                  </tr>
                {% endfor %}
              </table>
            {% else %}
              <p>Aucune connexion sortante.</p>
            {% endif %}
          </div>
        </div>
        <!-- Section des tâches -->
        <div class="tasks-section">
          <h3>Tâches</h3>
          <div id="tasks-container-{{ item.activity.id }}">
            {% if item.tasks and item.tasks|length > 0 %}
              <ul id="tasks-list-{{ item.activity.id }}">
                {% for task in item.tasks %}
                  <li class="task" id="task-{{ task.id }}" data-task-id="{{ task.id }}">
                    <div class="task-row">
                      <!-- Colonne de gauche -->
                      <div class="task-left">
                        <i class="fa-solid fa-bars icon-btn" style="cursor: move;"></i>
                        <span class="task-title">
                          <strong id="task-name-display-{{ task.id }}">{{ task.name }}</strong>
                          {% if task.description %}
                            - <span id="task-desc-display-{{ task.id }}">{{ task.description }}</span>
                          {% endif %}
                        </span>
                        <button class="icon-btn" onclick="deleteTask('{{ item.activity.id }}', '{{ task.id }}')">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                        <button class="icon-btn" onclick="showEditTaskForm('{{ item.activity.id }}', '{{ task.id }}', '{{ task.name }}', '{{ task.description | default('') }}')">
                          <i class="fa-solid fa-pencil"></i>
                        </button>
                      </div>
                      <!-- Colonne de droite -->
                      <div class="task-right">
                        <div class="tools-list" id="tools-for-task-{{ task.id }}">
                          <ul>
                            {% if task.tools and task.tools|length > 0 %}
                              {% for tool in task.tools %}
                                <li data-tool-id="{{ tool.id }}">
                                  <span class="tool-name">{{ tool.name }}</span>
                                  <button class="icon-btn" onclick="deleteToolFromTask('{{ task.id }}', '{{ tool.id }}')">
                                    <i class="fa-solid fa-trash"></i>
                                  </button>
                                </li>
                              {% endfor %}
                              <!-- Bouton "+" dans un li séparé placé après la liste des outils -->
                              <li class="add-tool-li">
                                <button class="icon-btn" onclick="showToolForm('{{ task.id }}')">
                                  <i class="fa-solid fa-plus"></i>
                                </button>
                              </li>
                            {% else %}
                              <li id="no-tools-msg-{{ task.id }}">
                                Aucun outil associé.
                                <button class="icon-btn" onclick="showToolForm('{{ task.id }}')">
                                  <i class="fa-solid fa-plus"></i>
                                </button>
                              </li>
                            {% endif %}
                          </ul>
                        </div>
                      </div>
                    </div>
                    <!-- Formulaire d'édition de la tâche, affiché sous la ligne -->
                    <div class="edit-task-form" id="edit-task-form-{{ task.id }}">
                      <input type="text" id="edit-task-name-{{ task.id }}" placeholder="Nom de la tâche" />
                      <input type="text" id="edit-task-desc-{{ task.id }}" placeholder="Description (optionnelle)" />
                      <button onclick="submitEditTask('{{ item.activity.id }}', '{{ task.id }}')">Enregistrer</button>
                      <button onclick="hideEditTaskForm('{{ task.id }}')">Annuler</button>
                    </div>
                    <!-- Formulaire d'ajout d'outils (invisible par défaut) -->
                    <div id="tool-form-{{ task.id }}" class="tool-form" style="display: none;">
                      <div>
                        <label for="existing-tools-{{ task.id }}">Outils existants:</label>
                        <select id="existing-tools-{{ task.id }}" multiple style="width: 100%;"></select>
                      </div>
                      <div>
                        <label for="new-tools-{{ task.id }}">Nouveaux outils (séparés par des virgules):</label>
                        <input type="text" id="new-tools-{{ task.id }}" placeholder="Ex: Outil1, Outil2" style="width: 100%;" />
                      </div>
                      <button onclick="submitTools('{{ task.id }}')">Enregistrer</button>
                      <button onclick="hideToolForm('{{ task.id }}')">Annuler</button>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p id="no-tasks-message-{{ item.activity.id }}">Aucune tâche enregistrée.</p>
            {% endif %}
          </div>
          <button onclick="showTaskForm('{{ item.activity.id }}')">
            <i class="fa-solid fa-plus"></i> Ajouter une tâche
          </button>
          <div id="task-form-{{ item.activity.id }}" class="task-form" style="display:none;">
            <input type="text" id="task-name-{{ item.activity.id }}" placeholder="Nom de la tâche" />
            <input type="text" id="task-desc-{{ item.activity.id }}" placeholder="Description (optionnelle)" />
            <button onclick="submitTask('{{ item.activity.id }}')">Enregistrer</button>
            <button onclick="hideTaskForm('{{ item.activity.id }}')">Annuler</button>
          </div>
        </div>
        <!-- Bouton pour proposer des compétences pour cette activité -->
        <button onclick="fetchActivityDetailsForSkills({{ item.activity.id }})" style="margin-top:10px; padding:8px 12px; font-size:0.9em;">
          Proposer Compétences
        </button>
      </div>
    </div>
  {% endfor %}
  <script>
    // Bouton de mise à jour de la cartographie
    document.getElementById('update-cartography-button').addEventListener('click', function() {
        fetch('/activities/update-cartography')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            alert(data.message + "\n" + data.summary);
            location.reload();
        })
        .catch(function(error) {
            alert("Erreur lors de la mise à jour de la cartographie: " + error.message);
        });
    });
    function toggleDetails(detailsId, headerElem) {
        var detailsElem = document.getElementById(detailsId);
        var iconElem = headerElem.querySelector('.toggle-icon');
        var currentDisplay = window.getComputedStyle(detailsElem).display;
        if (currentDisplay === "none") {
            detailsElem.style.display = "block";
            iconElem.textContent = "▼";
        } else {
            detailsElem.style.display = "none";
            iconElem.textContent = "▶";
        }
    }
    // Gestion du formulaire d'ajout de tâche
    function showTaskForm(activityId) {
        document.getElementById('task-form-' + activityId).style.display = 'block';
    }
    function hideTaskForm(activityId) {
        document.getElementById('task-form-' + activityId).style.display = 'none';
    }
    function submitTask(activityId) {
        var taskName = document.getElementById('task-name-' + activityId).value;
        var taskDesc = document.getElementById('task-desc-' + activityId).value;
        if (!taskName) {
            alert("Le nom de la tâche est requis.");
            return;
        }
        fetch('/activities/' + activityId + '/tasks/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: taskName, description: taskDesc })
        })
        .then(function(response) {
            if (response.ok) return response.json();
            throw new Error("Erreur lors de l'ajout de la tâche.");
        })
        .then(function(data) {
            var tasksList = document.getElementById('tasks-list-' + activityId);
            if (!tasksList) {
                var noTasksMsg = document.getElementById('no-tasks-message-' + activityId);
                if (noTasksMsg) { noTasksMsg.parentNode.removeChild(noTasksMsg); }
                tasksList = document.createElement('ul');
                tasksList.id = 'tasks-list-' + activityId;
                var tasksSection = document.getElementById('task-form-' + activityId).parentNode;
                tasksSection.appendChild(tasksList);
            }
            var li = document.createElement('li');
            li.className = 'task';
            li.id = 'task-' + data.id;
            li.setAttribute('data-task-id', data.id);
            li.innerHTML = '<div class="task-row">' +
                           '<div class="task-left">' +
                           '<i class="fa-solid fa-bars icon-btn" style="cursor: move;"></i>' +
                           '<span class="task-title"><strong id="task-name-display-' + data.id + '">' + data.name + '</strong>' +
                           (data.description ? ' - <span id="task-desc-display-' + data.id + '">' + data.description + '</span>' : '') +
                           '</span>' +
                           '<button class="icon-btn" onclick="deleteTask(\'' + activityId + '\', \'' + data.id + '\')"><i class="fa-solid fa-trash"></i></button>' +
                           '<button class="icon-btn" onclick="showEditTaskForm(\'' + activityId + '\', \'' + data.id + '\', \'' + data.name + '\', \'' + data.description + '\')"><i class="fa-solid fa-pencil"></i></button>' +
                           '</div>' +
                           '<div class="task-right">' +
                           '<div class="tools-list" id="tools-for-task-' + data.id + '">' +
                           '<ul>' +
                           '<li id="no-tools-msg-' + data.id + '">Aucun outil associé.</li>' +
                           '<li class="add-tool-li">' +
                           '<button class="icon-btn" onclick="showToolForm(\'' + data.id + '\')"><i class="fa-solid fa-plus"></i></button>' +
                           '</li>' +
                           '</ul>' +
                           '</div>' +
                           '</div>' +
                           '</div>' +
                           '<div class="edit-task-form" id="edit-task-form-' + data.id + '">' +
                           '<input type="text" id="edit-task-name-' + data.id + '" placeholder="Nom de la tâche" />' +
                           '<input type="text" id="edit-task-desc-' + data.id + '" placeholder="Description (optionnelle)" />' +
                           '<button onclick="submitEditTask(\'' + activityId + '\', \'' + data.id + '\')">Enregistrer</button>' +
                           '<button onclick="hideEditTaskForm(\'' + data.id + '\')">Annuler</button>' +
                           '</div>' +
                           '<div id="tool-form-' + data.id + '" class="tool-form" style="display: none;">' +
                           '<div><label for="existing-tools-' + data.id + '">Outils existants:</label>' +
                           '<select id="existing-tools-' + data.id + '" multiple style="width: 100%;"></select></div>' +
                           '<div><label for="new-tools-' + data.id + '">Nouveaux outils (séparés par des virgules):</label>' +
                           '<input type="text" id="new-tools-' + data.id + '" placeholder="Ex: Outil1, Outil2" style="width: 100%;" /></div>' +
                           '<button onclick="submitTools(\'' + data.id + '\')">Enregistrer</button>' +
                           '<button onclick="hideToolForm(\'' + data.id + '\')">Annuler</button>' +
                           '</div>';
            tasksList.appendChild(li);
            document.getElementById('task-name-' + activityId).value = "";
            document.getElementById('task-desc-' + activityId).value = "";
            hideTaskForm(activityId);
        })
        .catch(function(error) {
            alert(error.message);
        });
    }
    // Suppression d'une tâche
    function deleteTask(activityId, taskId) {
        if (!confirm("Confirmez-vous la suppression de cette tâche ?")) return;
        fetch('/activities/' + activityId + '/tasks/' + taskId, { method: 'DELETE' })
        .then(function(response) {
            if (response.ok) return response.json();
            throw new Error("Erreur lors de la suppression de la tâche.");
        })
        .then(function(data) {
            alert(data.message);
            var taskElem = document.getElementById('task-' + taskId);
            if (taskElem) { taskElem.parentNode.removeChild(taskElem); }
        })
        .catch(function(error) {
            alert(error.message);
        });
    }
    // Fonction pour afficher le formulaire d'édition d'une tâche
    function showEditTaskForm(activityId, taskId, name, description) {
        document.getElementById('edit-task-form-' + taskId).style.display = 'block';
        document.getElementById('edit-task-name-' + taskId).value = name;
        document.getElementById('edit-task-desc-' + taskId).value = description;
    }
    function hideEditTaskForm(taskId) {
        document.getElementById('edit-task-form-' + taskId).style.display = 'none';
    }
    function submitEditTask(activityId, taskId) {
        var newName = document.getElementById('edit-task-name-' + taskId).value;
        var newDesc = document.getElementById('edit-task-desc-' + taskId).value;
        if (!newName) {
            alert("Le nom de la tâche est requis.");
            return;
        }
        fetch('/activities/' + activityId + '/tasks/' + taskId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName, description: newDesc })
        }).then(function(response) {
            if (response.ok) return response.json();
            throw new Error("Erreur lors de la mise à jour de la tâche.");
        }).then(function(data) {
            var nameElem = document.getElementById('task-name-display-' + taskId);
            if (nameElem) { nameElem.textContent = data.name; }
            var descElem = document.getElementById('task-desc-display-' + taskId);
            if (descElem) { 
                descElem.textContent = data.description;
            } else {
                var taskTitle = document.querySelector('#task-name-display-' + taskId).parentNode;
                var span = document.createElement('span');
                span.id = 'task-desc-display-' + taskId;
                span.textContent = data.description;
                taskTitle.appendChild(document.createTextNode(" - "));
                taskTitle.appendChild(span);
            }
            hideEditTaskForm(taskId);
        }).catch(function(error) {
            alert(error.message);
        });
    }
    // Suppression d'un outil d'une tâche sans recharger la page
    function deleteToolFromTask(taskId, toolId) {
        if (!confirm("Confirmez-vous la suppression de cet outil de la tâche ?")) return;
        fetch('/activities/tasks/' + taskId + '/tools/' + toolId, { method: 'DELETE' })
        .then(function(response) {
            if (response.ok) return response.json();
            throw new Error("Erreur lors de la suppression de l'outil.");
        })
        .then(function(data) {
            var toolsContainer = document.getElementById('tools-for-task-' + taskId);
            var ul = toolsContainer.querySelector('ul');
            if (!ul) return;
            var toolElem = ul.querySelector('li[data-tool-id="' + toolId + '"]');
            if (toolElem) { 
                toolElem.parentNode.removeChild(toolElem);
            }
            // Vérifier si le bouton "+" existe ; si non, le réinsérer
            var addBtn = ul.querySelector('li.add-tool-li');
            if (!addBtn) {
                var newAddLi = document.createElement('li');
                newAddLi.className = 'add-tool-li';
                newAddLi.innerHTML = '<button class="icon-btn" onclick="showToolForm(\'' + taskId + '\')"><i class="fa-solid fa-plus"></i></button>';
                ul.appendChild(newAddLi);
            }
        })
        .catch(function(error) {
            alert(error.message);
        });
    }
    // Fonctions pour gérer le formulaire d'ajout d'outils
    function showToolForm(taskId) {
        document.getElementById('tool-form-' + taskId).style.display = 'block';
        fetch('/tools/all')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            var selectElem = document.getElementById('existing-tools-' + taskId);
            selectElem.innerHTML = "";
            data.forEach(function(tool) {
                var option = document.createElement('option');
                option.value = tool.id;
                option.text = tool.name;
                selectElem.appendChild(option);
            });
        })
        .catch(function(error) {
            console.error("Erreur lors du chargement des outils existants:", error);
        });
    }
    function hideToolForm(taskId) {
        document.getElementById('tool-form-' + taskId).style.display = 'none';
    }
    function submitTools(taskId) {
        var selectElem = document.getElementById('existing-tools-' + taskId);
        var newToolsInput = document.getElementById('new-tools-' + taskId);
        var existingToolIds = Array.from(selectElem.selectedOptions).map(function(option) { return parseInt(option.value); });
        var newTools = newToolsInput.value.split(",").map(function(item) { return item.trim(); }).filter(function(item) { return item.length > 0; });
        var payload = {
            task_id: parseInt(taskId),
            existing_tool_ids: existingToolIds,
            new_tools: newTools
        };
        fetch('/tools/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(response) {
            if (response.ok) return response.json();
            return response.json().then(function(err) { throw new Error(err.error || "Erreur lors de l'ajout des outils."); });
        })
        .then(function(data) {
            var toolsContainer = document.getElementById('tools-for-task-' + taskId);
            var ul = toolsContainer.querySelector('ul');
            if (!ul) {
                ul = document.createElement('ul');
                toolsContainer.appendChild(ul);
            }
            // Retirer le bouton "+" existant s'il est présent
            var addBtn = ul.querySelector('li.add-tool-li');
            if (addBtn) {
                addBtn.parentNode.removeChild(addBtn);
            }
            data.added_tools.forEach(function(tool) {
                var li = document.createElement('li');
                li.setAttribute("data-tool-id", tool.id);
                li.innerHTML = tool.name + ' <button class="icon-btn" onclick="deleteToolFromTask(\'' + taskId + '\', \'' + tool.id + '\')"><i class="fa-solid fa-trash"></i></button>';
                ul.appendChild(li);
            });
            // Réinsérer le bouton "+" en tant que li isolé
            var newAddLi = document.createElement('li');
            newAddLi.className = 'add-tool-li';
            newAddLi.innerHTML = '<button class="icon-btn" onclick="showToolForm(\'' + taskId + '\')"><i class="fa-solid fa-plus"></i></button>';
            ul.appendChild(newAddLi);
            selectElem.selectedIndex = -1;
            newToolsInput.value = "";
            hideToolForm(taskId);
        })
        .catch(function(error) {
            alert(error.message);
        });
    }
    // Initialisation du drag & drop pour réordonner les tâches et sauvegarder l'ordre
    document.addEventListener('DOMContentLoaded', function() {
        var taskLists = document.querySelectorAll('[id^="tasks-list-"]');
        taskLists.forEach(function(list) {
            Sortable.create(list, {
                animation: 150,
                handle: '.fa-bars',
                onEnd: function(evt) {
                    var list = evt.from;
                    var listId = list.getAttribute('id'); // e.g. tasks-list-123
                    var activityId = listId.split('-')[2]; // Extrait l'id de l'activité
                    var newOrder = [];
                    list.querySelectorAll('li.task').forEach(function(taskElem) {
                        newOrder.push(taskElem.getAttribute('data-task-id'));
                    });
                    fetch('/activities/' + activityId + '/tasks/reorder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order: newOrder })
                    }).then(function(response) {
                        if (!response.ok) {
                            console.error("Erreur de sauvegarde de l'ordre");
                        }
                    });
                }
            });
        });
    });
  </script>
  {% include "skills_section.html" %}
</body>
</html>
