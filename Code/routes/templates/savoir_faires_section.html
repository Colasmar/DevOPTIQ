<!-- Code/routes/templates/savoir_faires_section.html -->

<script>
    function fetchActivityDetailsForSavoirFaires(activityId) {
        showSpinner();
        fetch(`/activities/${activityId}/details`)
            .then(response => {
                if (!response.ok) {
                    hideSpinner();
                    throw new Error("Erreur lors de la récupération des détails de l'activité");
                }
                return response.json();
            })
            .then(activityData => {
                hideSpinner();
                proposeSavoirFaires(activityData);
            })
            .catch(error => {
                hideSpinner();
                alert("Erreur lors de la récupération des données : " + error.message);
            });
    }
    
    function proposeSavoirFaires(activityData) {
        showSpinner();
    
        fetch("/savoirs/propose_savoir_faires", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                name: activityData.title,
                input_data: activityData.input_data,
                output_data: activityData.output_data
            })
        })
        .then(response => {
            if (!response.ok) {
                hideSpinner();
                return response.text().then(text => {
                    throw new Error(`Réponse invalide de /savoirs/propose_savoir_faires: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            hideSpinner();
            if (data.error) {
                alert("Erreur IA : " + data.error);
                return;
            }
    
            const lines = data.proposals; 
            if (!lines || !Array.isArray(lines) || lines.length === 0) {
                alert("Aucune proposition retournée.");
                return;
            }
    
            
            showSavoirFairesProposalsModal(lines, activityData.id);
        })
        .catch(error => {
            hideSpinner();
            alert("Erreur lors de la proposition de savoirs : " + error.message);
        });
    }
    </script>