<!-- competency_modal.html -->
<div id="competencyModal"
     style="display:none; position:fixed; left:20%; top:20%; width:60%; background:#fff;
            border:1px solid #aaa; padding:10px; z-index:9999;">
  <h4>Propositions de compétences :</h4>

  <!-- Liste UL qui contiendra chaque proposition IA sous forme de cases à cocher -->
  <ul id="proposalsList" style="list-style:none; padding-left:0;"></ul>

  <!-- Boutons d'action -->
  <div style="margin-top:10px;">
    <button onclick="validateAllSelectedProposals()">Valider les compétences</button>
    <button onclick="closeCompetencyModal()">Annuler</button>
  </div>
</div>

<!-- Modal pour éditer UNE compétence déjà validée -->
<div id="editCompetencyModal"
     style="display:none; position:fixed; left:25%; top:25%; width:50%; background:#fff;
            border:1px solid #aaa; padding:10px; z-index:9999;">
  <h4>Modifier la compétence :</h4>
  <textarea id="editCompetencyText" style="width:100%; height:80px;"></textarea>
  <div style="margin-top:10px;">
    <button onclick="saveEditedCompetency()">Enregistrer</button>
    <button onclick="closeEditCompetencyModal()">Annuler</button>
  </div>
</div>

<script>
  let proposalsGlobal = [];
  let currentActivityId = null; // Stocke l'ID de l'activité quand on clique sur "Proposer Compétences"
  let editingLiElem = null;     // Pour éditer une compétence validée

  /**
   * Ouvre le modal qui liste chaque proposition IA sous forme de cases à cocher
   */
  function showProposalsModal(proposals, activityId) {
    proposalsGlobal = proposals;
    currentActivityId = activityId;

    const proposalsList = document.getElementById('proposalsList');
    proposalsList.innerHTML = "";

    proposals.forEach((proposal, index) => {
      const li = document.createElement('li');
      li.style.marginBottom = "5px";
      li.innerHTML = `
        <input type="checkbox" id="proposal-${index}" data-proposal="${proposal}">
        <label for="proposal-${index}">${proposal}</label>
      `;
      proposalsList.appendChild(li);
    });

    document.getElementById('competencyModal').style.display = "block";
  }

  /**
   * Valide toutes les propositions cochées et les ajoute à la liste
   * #competencies-list-<currentActivityId>
   */
  function validateAllSelectedProposals() {
    const proposalsList = document.getElementById('proposalsList');
    const checkboxes = proposalsList.querySelectorAll('input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
      alert("Veuillez sélectionner au moins une proposition.");
      return;
    }

    const container = document.getElementById('competencies-list-' + currentActivityId);
    checkboxes.forEach(cb => {
      const text = cb.getAttribute('data-proposal') || "Compétence ?";
      const li = document.createElement('li');
      li.style.marginBottom = "5px";
      li.innerHTML = `
        <span class="validated-skill-text">${text}</span>
        <button onclick="editValidatedSkill(this)" style="margin-left:5px;">
          <i class="fa-solid fa-pencil"></i>
        </button>
        <button onclick="deleteValidatedSkill(this)" style="margin-left:5px;">
          <i class="fa-solid fa-trash"></i>
        </button>
      `;
      container.appendChild(li);
    });

    closeCompetencyModal();
  }

  function closeCompetencyModal() {
    document.getElementById('competencyModal').style.display = "none";
  }

  /**
   * Clique sur le crayon pour éditer une compétence validée
   */
  function editValidatedSkill(buttonElem) {
    editingLiElem = buttonElem.parentNode;
    const skillTextElem = editingLiElem.querySelector('.validated-skill-text');
    const skillText = skillTextElem.textContent.trim();

    // Ouvre le modal d'édition
    document.getElementById('editCompetencyText').value = skillText;
    document.getElementById('editCompetencyModal').style.display = "block";
  }

  function closeEditCompetencyModal() {
    document.getElementById('editCompetencyModal').style.display = "none";
    editingLiElem = null;
  }

  /**
   * Enregistre la compétence modifiée dans le <li> existant
   */
  function saveEditedCompetency() {
    if (!editingLiElem) {
      closeEditCompetencyModal();
      return;
    }
    const newText = document.getElementById('editCompetencyText').value.trim();
    if (!newText) {
      alert("Veuillez saisir un texte.");
      return;
    }
    const skillTextElem = editingLiElem.querySelector('.validated-skill-text');
    skillTextElem.textContent = newText;
    closeEditCompetencyModal();
  }

  /**
   * Supprime la compétence validée
   */
  function deleteValidatedSkill(buttonElem) {
    const li = buttonElem.parentNode;
    li.parentNode.removeChild(li);
  }
</script>
